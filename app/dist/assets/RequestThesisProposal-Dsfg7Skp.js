import{t as n,j as s,M as he,v as h,T as _,D as Q,A as c,B as O,E as fe}from"./index-B7_hvkM2.js";import{G as B}from"./Grid-C85KIsm1.js";import{G as M}from"./Group-dxvsYpX2.js";import{C as H}from"./Checkbox-BOck0Pse.js";import{S as N}from"./Space-CyCyKMgB.js";import{F as X}from"./Flex-CXnzITNo.js";import{B as v}from"./Button-fInQYk36.js";import{M as me}from"./ModalApprove-GxzTwETF.js";import{M as xe}from"./ModalPay-B7m0CAUf.js";import{M as _e}from"./ModalInform-NNINQB9X.js";import{P as je}from"./Pdfg03-04-Eg6H1Izd.js";import{j as ge}from"./index-VWaDGczM.js";import{u as ye}from"./use-form-DDBi_7fX.js";import{S as K}from"./Stepper-B-uTcAaD.js";import{P as E}from"./Pill-B7ktLfj6.js";import"./get-sorted-breakpoints-BmTdo-hw.js";import"./Image-QhnbGiva.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./PdfUtils-2D7kTCyc.js";import"./dayjs.min-TNDP4t9g.js";const ve="http://localhost:8080",Se=({opened:d,onClose:j,title:l,form:o,handleAdd:S})=>{const[u,A]=n.useState([]),q=localStorage.getItem("token");return n.useEffect(()=>{d&&(async()=>{try{const f=await fetch(`${ve}/api/getAdvisors`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${q}`}}),m=await f.json();if(!f.ok)throw new Error(m.message);A(m.map(w=>({value:w.user_id,label:w.name})))}catch(f){console.error("Error fetching advisors:",f)}})()},[d,q]),s.jsx(he,{opened:d,onClose:j,title:l,centered:!0,size:"800",children:s.jsxs("form",{onSubmit:o.onSubmit(S),children:[s.jsxs(B,{breakpoints:{md:"660px"},children:[s.jsxs(B.Col,{span:{base:12,md:6},children:[s.jsx(h,{label:"ชื่อ-นามสกุล",disabled:!0,...o.getInputProps("student_name")}),s.jsx(h,{label:"รหัสประจำตัว",disabled:!0,...o.getInputProps("student_id")}),s.jsx(h,{label:"ระดับการศึกษา",disabled:!0,...o.getInputProps("education_level")}),s.jsx(h,{label:"หลักสูตร",disabled:!0,...o.getInputProps("program")}),s.jsx(h,{label:"สาขาวิชา",disabled:!0,...o.getInputProps("major_name")}),s.jsx(h,{label:"คณะ",disabled:!0,...o.getInputProps("faculty_name")})]}),s.jsxs(B.Col,{span:{base:12,md:6},children:[s.jsx(_,{children:"เลือกชนิดโครงร่างงานวิจัย"}),s.jsxs(M,{direction:"column",spacing:"xs",children:[s.jsx(H,{checked:o.values.request_type==="วิทยานิพนธ์",onChange:()=>o.setFieldValue("request_type","วิทยานิพนธ์"),label:"วิทยานิพนธ์"}),s.jsx(H,{checked:o.values.request_type==="การค้นคว้าอิสระ",onChange:()=>o.setFieldValue("request_type","การค้นคว้าอิสระ"),label:"การค้นคว้าอิสระ"}),o.errors.request_type&&s.jsx(_,{c:"red",size:"sm",children:o.errors.request_type})]}),s.jsx(N,{h:"md"}),s.jsx(h,{label:"ชื่องานวิจัย",placeholder:"กรอกชื่องานวิจัย",...o.getInputProps("research_name")}),s.jsx(Q,{label:"เลือกอาจารย์ที่ปรึกษางานวิจัย",placeholder:"เลือกอาจารย์",data:u,...o.getInputProps("thesis_advisor_id")})]})]}),s.jsx(N,{h:"lg"}),s.jsx(X,{justify:"flex-end",children:s.jsx(v,{type:"submit",color:"green",children:"บันทึก"})})]})})},p="http://localhost:8080",We=()=>{const d=localStorage.getItem("token"),j=ge(d),l=j.role;j.user_id,console.log("token :",j);const[o,S]=n.useState({open:!1,type:"",message:""}),u=(e,t)=>S({open:!0,type:e,message:t}),A=()=>S(e=>({...e,open:!1})),[q,T]=n.useState(!1),[f,m]=n.useState(!1),[w,Y]=n.useState(!1),[Z,C]=n.useState(!1),[F,G]=n.useState(null),[k,L]=n.useState("approve"),[$,J]=n.useState(""),[ee,se]=n.useState(""),[I,te]=n.useState(""),[V,b]=n.useState([]),[W,re]=n.useState(""),g=ye({initialValues:{student_name:"",student_id:"",education_level:"",program:"",major_name:"",faculty_name:"",request_type:"",research_name:"",thesis_advisor_id:"",thesis_exam_date:null},validate:{request_type:e=>e===""?"กรุณาเลือกชนิดโครงร่างงานวิจัย":null,research_name:e=>e===""?"กรุณากรอกชื่องานวิจัย":null,thesis_advisor_id:e=>e===""?"กรุณาเลือกอาจารย์ที่ปรึกษางานวิจัย":null}}),[ae,oe]=n.useState([]),[D,U]=n.useState("");n.useEffect(()=>{(async()=>{try{const r=await fetch(`${p}/api/profile`,{method:"GET",headers:{Authorization:`Bearer ${d}`}}),a=await r.json();if(!r.ok)throw new Error(a.message);te(a),console.log(a)}catch(r){u("error",r.message),console.error("Error fetching profile:",r)}})(),(async()=>{try{const r=await fetch(`${p}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`}}),a=await r.json();if(!r.ok)throw new Error(a.message);oe(a.map(x=>x.term)),console.log(a);const i=new Date;let y=a.find(x=>{const z=new Date(x.term_open_date),pe=new Date(x.term_close_date);return i>=z&&i<=pe});!y&&a.length>0&&(y=[...a].sort((x,z)=>new Date(z.term_close_date)-new Date(x.term_close_date))[0]),U(y.term)}catch(r){u("error",r.message),console.error("Error fetching allRequestExamInfo:",r)}})()},[]);const[P,R]=n.useState(!0);n.useEffect(()=>{(async()=>{try{const t=await fetch(`${p}/api/allRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({term:D})}),r=await t.json();if(!t.ok)throw new Error(r.message);if(b(r),l==="student"){const a=await fetch(`${p}/api/requestExamAll`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({lastRequest:!0})}),i=await a.json();if(!a.ok)throw new Error(i.message);i[0]?.status==="5"&&i[0]?.exam_results==="ผ่าน"&&(r[0]?.status==="6"||r[0]?.status===void 0)?R(!1):R(!0)}}catch(t){u("error",t.message),console.error("Error fetching allRequestThesisProposal:",t)}})()},[D]);const ne=async()=>{try{const e=await fetch(`${p}/api/studentInfo`,{method:"GET",headers:{Authorization:`Bearer ${d}`}}),t=await e.json();if(!e.ok)throw new Error(t.message);g.setValues({request_type:"",thesis_advisor_id:"",thesis_exam_date:null}),g.setValues(t),T(!0)}catch(e){u("error",e.message),console.error("Error fetching studentInfo:",e)}},le=async()=>{try{const e=await fetch(`${p}/api/addRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify(g.values)}),t=await e.json();if(!e.ok)throw new Error(t.message);u("success",t.message),T(!1),b(r=>[...r,{...t.data,...g.values}]),R(!0)}catch(e){u("error",e.message),console.error("Error fetching addRequestThesisProposal:",e)}},ie=async e=>{if(k==="noapprove"&&$.trim()===""){se("กรุณาระบุเหตุผล");return}try{const t=await fetch(`${p}/api/approveRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({request_thesis_proposal_id:e.request_thesis_proposal_id,name:I.name,role:l,selected:k,comment:$})}),r=await t.json();if(!t.ok)throw new Error(r.message);u("success",r.message||"สำเร็จ"),L("approve"),J(""),m(!1),b(a=>a.map(i=>i.request_thesis_proposal_id===e.request_thesis_proposal_id?{...i,...r.data}:i))}catch(t){u("error",t.message),console.error("Error fetching approveRequestThesisProposal:",t)}},ce=async e=>{try{const t=await fetch(`${p}/api/payRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({request_thesis_proposal_id:e.request_thesis_proposal_id,receipt_vol:"154",receipt_No:"4",receipt_pay:"1000"})}),r=await t.json();if(!t.ok)throw new Error(r.message);u("success",r.message||"สำเร็จ"),C(!1),b(a=>a.map(i=>i.request_thesis_proposal_id===e.request_thesis_proposal_id?{...i,...r.data}:i))}catch(t){u("error",t.message),console.error("Error fetching payRequestThesisProposal:",t)}};function de(e,t){return t==="student"?e:e.sort((r,a)=>{const i=Number(r.status)===0?1:0,y=Number(a.status)===0?1:0;return i-y||Number(r.status)-Number(a.status)})}const ue=de(V,l).filter(e=>[e.student_name,e.student_id].join(" ").toLowerCase().includes(W.toLowerCase())).map(e=>s.jsxs(c.Tr,{children:[s.jsx(c.Td,{children:e.student_name}),s.jsx(c.Td,{children:e.request_type}),s.jsxs(c.Td,{style:{textAlign:"center"},children:[e.status<=4&&e.status>0&&s.jsx(K,{active:e.status-1,iconSize:20,styles:{separator:{marginLeft:-4,marginRight:-4},stepIcon:{fontSize:10}},children:[...Array(4)].map((t,r)=>s.jsx(K.Step,{children:s.jsx(E,{children:e.status_text})},r))}),(e.status==0||e.status>6)&&s.jsx(E,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),e.status==5&&s.jsx(E,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:e.status_text}),e.status==6&&s.jsxs(s.Fragment,{children:[s.jsx(E,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),s.jsx("br",{}),!e.advisor_approvals&&"อาจารย์ที่ปรึกษา",e.advisor_approvals&&!e.chairpersons_approvals&&"ประธานหลักสูตร",e.advisor_approvals&&e.chairpersons_approvals&&!e.registrar_approvals&&"เจ้าหน้าที่ทะเบียน"]})]}),s.jsx(c.Td,{style:{maxWidth:"150px"},children:s.jsxs(M,{children:[l==="student"&&s.jsxs(s.Fragment,{children:[e.status==="4"&&s.jsx(v,{size:"xs",color:"green",onClick:()=>{G(e),C(!0)},children:"ชำระค่าธรรมเนียม"}),(e.status==5||e.status==0||e.status>6)&&s.jsx(v,{size:"xs",color:"green",children:"พิมพ์ใบเสร็จ"})]}),s.jsx(je,{data:e,showType:e.status==0?void 0:l==="advisor"&&e.status<=1||l==="chairpersons"&&e.status<=2||l==="officer_registrar"&&e.status<=3?"view":void 0}),(l==="research_advisor"&&e.status==1||l==="chairpersons"&&e.status==2||l==="officer_registrar"&&e.status==3)&&s.jsx(v,{size:"xs",color:"green",onClick:()=>{G(e),Y("add"),m(!0)},children:l==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"})]})}),e.exam_results!==null&&s.jsxs(c.Td,{style:{textAlign:"center"},children:[e.exam_results==="ผ่าน"&&s.jsx(_,{c:"green",children:"ผ่าน"}),e.exam_results==="ไม่ผ่าน"&&s.jsx(_,{c:"red",children:"ไม่ผ่าน"}),e.exam_results==="ขาดสอบ"&&s.jsx(_,{c:"gray",children:"ขาดสอบ"})]})]},e.request_thesis_proposal_id));return s.jsxs(O,{children:[s.jsx(_e,{opened:o.open,onClose:A,message:o.message,type:o.type}),s.jsx(me,{opened:f,onClose:()=>m(!1),selectedRow:F,selected:k,setSelected:L,comment:$,setComment:J,error:ee,openApproveState:w,handleApprove:ie,role:l,title:`${l==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"}คำร้องขอสอบโครงร่าง${I.education_level==="ปริญญาโท"?"วิทยานิพนธ์":"การค้นคว้าอิสระ"}`}),s.jsx(Se,{opened:q,onClose:()=>T(!1),form:g,handleAdd:le,title:"เพิ่มคำร้องขอสอบโครงร่างวิทยานิพนธ์/การค้นคว้าอิสระ"}),s.jsx(xe,{opened:Z,onClose:()=>C(!1),selectedRow:F,handlePay:ce,MoneyRegis:I.education_level==="ปริญญาโท"?2e3:5e3,stop_date:"15/11/2568"}),s.jsx(_,{size:"1.5rem",fw:900,mb:"md",children:"คำร้องขอสอบโครงร่างวิทยานิพนธ์/การค้นคว้าอิสระ"}),s.jsxs(M,{justify:"space-between",children:[s.jsx(O,{children:s.jsxs(X,{align:"flex-end",gap:"sm",children:[l!=="student"&&s.jsx(h,{placeholder:"ค้นหาชื่่อ รหัส",value:W,onChange:e=>re(e.target.value)}),s.jsx(Q,{placeholder:"เทอมการศึกษา",data:ae,value:D,onChange:U,allowDeselect:!1})]})}),s.jsx(O,{children:l==="student"&&s.jsx(v,{onClick:()=>ne(),disabled:P?P.status!=="0"&&P.status!=="6"&&P.exam_results!==!1:!1,children:"เพิ่มคำร้อง"})})]}),s.jsx(N,{h:"md"}),s.jsx(fe,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:s.jsxs(c,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[s.jsx(c.Thead,{children:s.jsxs(c.Tr,{children:[s.jsx(c.Th,{style:{minWidth:100},children:"ชื่อ"}),s.jsx(c.Th,{style:{minWidth:100},children:"เรื่อง"}),s.jsx(c.Th,{style:{minWidth:110},children:"สถานะ"}),s.jsx(c.Th,{children:"การดำเนินการ"}),V.some(e=>e.exam_results!==null)&&s.jsx(c.Th,{style:{minWidth:110},children:"ผลสอบ"})]})}),s.jsx(c.Tbody,{children:ue})]})})]})};export{We as default};
