import{t as _,j as e,B as z,T as L,D as X,E as H,A as r,M as J}from"./index-B7_hvkM2.js";import{M as K}from"./ModalInform-NNINQB9X.js";import{P as Q,f as Z,s as ee,d as B,e as N,h as F,i as b,j as U}from"./PdfUtils-2D7kTCyc.js";import{u as I,w as te}from"./xlsx-mxuUxWRI.js";import{u as se}from"./use-form-DDBi_7fX.js";import{G as P}from"./Group-dxvsYpX2.js";import{S as Y}from"./Space-CyCyKMgB.js";import{B as S}from"./Button-fInQYk36.js";import{C as re}from"./Checkbox-BOck0Pse.js";import{D as oe}from"./DatePickerInput-DIAi7llo.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./dayjs.min-TNDP4t9g.js";import"./use-disclosure-f2FIm-Gp.js";async function ae(c){const u=await Q.create();u.registerFontkit(Z);const f=u.addPage([595,842]),h=await ee(u),M=await fetch("/icons/KPRU-LOGO-line2.png").then(a=>a.arrayBuffer()),T=await u.embedPng(M),y=T.scale(.125),E=25,l=20;let D=0,R=`ประจำภาคเรียนที่ ${c[0].term}`;for(;D*E<c.length;){const a=D===0?f:u.addPage([595,842]),j=D*E,w=Math.min(j+E,c.length),k=(a.getWidth()-y.width)/2;a.drawImage(T,{x:k,y:700,width:y.width,height:y.height});let n=600;B(a,"ผลการสอบวิทยานิพนธ์/การค้นคว้าอิสระ",680,h,16),B(a,`สาขาวิชา${c[0].major_name}`,660,h,16),B(a,R,640,h,16),N(a,60,n,490,l),F(a,100,n+l,100,n-(w-j)*l),F(a,230,n+l,230,n-(w-j)*l),F(a,440,n+l,440,n-(w-j)*l),b(a,"ลำดับ",60,n,40,l,h,14),b(a,"รหัสนักศึกษา",100,n,130,l,h,14),b(a,"ชื่อ - นามสกุล",230,n,210,l,h,14),b(a,"ผลการสอบ",440,n,110,l,h,14);for(let i=j;i<w;i++){n-=l,N(a,60,n,490,l),b(a,`${i+1}`,60,n,40,l,h,14),b(a,`${c[i].student_id}`,100,n,130,l,h,14);const C=c[i].name?c[i].name.split(/\s+/).filter(Boolean):["",""],v=C[0]||"",$=C.slice(1).join(" ");U(a,v,260,n,l,h,14),U(a,$,350,n,l,h,14),c[i].exam_results!==null&&c[i].exam_results!==void 0&&b(a,c[i].exam_results,440,n,110,l,h,14)}D++}const O=await u.save();return new Blob([O],{type:"application/pdf"})}async function ne(c){console.log("ข้อมูลที่จะพิมพ์:",c);try{const u=await ae(c),f=URL.createObjectURL(u);window.open(f,"_blank")}catch(u){console.error("เกิดข้อผิดพลาดสร้าง PDF:",u)}}const A="http://localhost:8080",ye=()=>{const[c,u]=_.useState({open:!1,type:"",message:""}),f=(s,t)=>u({open:!0,type:s,message:t}),h=()=>u(s=>({...s,open:!1})),[M,T]=_.useState(!1),y=localStorage.getItem("token"),[E,l]=_.useState([]),[D,R]=_.useState(!1),[O,a]=_.useState([]),[j,w]=_.useState(""),[k,n]=_.useState(""),i=se({}),C=s=>{const[t,o]=s.split("/").map(Number);return o*10+t},v={ดีเยี่ยม:"blue",ดี:"green",ผ่าน:"green",ไม่ผ่าน:"red",ขาดสอบ:"gray"};_.useEffect(()=>{(async()=>{try{const t=await fetch(`${A}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`}}),o=await t.json();if(!t.ok)throw new Error(o.message);l(o.map(d=>d.term));const m=new Date;let x=o.find(d=>{const p=new Date(d.term_open_date),g=new Date(d.term_close_date);return m>=p&&m<=g});!x&&o.length>0&&(x=[...o].sort((d,p)=>new Date(p.term_close_date)-new Date(d.term_close_date))[0]),x&&w(x.term)}catch(t){f("error",t.message)}})()},[]),_.useEffect(()=>{(async()=>{try{const t=await fetch(`${A}/api/AllExamDefenseResults`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`}}),o=await t.json();if(!t.ok)throw new Error(o.message);a(o)}catch(t){f("error",t.message)}R(!1)})()},[D]);const $=s=>{const t=s[0].study_group_id,o=s[0].term;n({[t]:{[o]:s}});const m={};s.forEach(x=>{m[x.student_id]={result:x.exam_results??"ดีเยี่ยม",date:x.thesis_exam_date?new Date(x.thesis_exam_date):null}}),i.setValues(m)},q=async()=>{try{const s=await fetch(`${A}/api/AddExamDefenseResults`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`},body:JSON.stringify({...i.values,term:j})}),t=await s.json();if(!s.ok)throw new Error(t.message);f("success",t.message),T(!1),R(!0),n(""),i.reset()}catch(s){f("error",s.message)}},V=(s,t="ผลการสอบ.xlsx")=>{const o=s.map(d=>({รหัสนักศึกษา:d.student_id,"ชื่อ-สกุล":d.name,ผลสอบ:d.exam_results,วันที่สอบ:d.thesis_exam_date?new Date(d.thesis_exam_date).toLocaleDateString("th-TH"):"",หมู่เรียน:d.study_group_id,เทอม:d.term})),m=I.json_to_sheet(o),x=I.book_new();I.book_append_sheet(x,m,"ผลการสอบ"),te(x,t)},W=s=>{if(Object.values(s).some(o=>!o.date)){f("error","กรุณาระบุวันที่สอบให้ครบถ้วน");return}T(!0)},G=(s,t,o,m=!1)=>Object.values(s).flatMap(x=>Object.values(x).flatMap(d=>d.map(p=>e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:p.student_id}),e.jsx(r.Td,{children:p.name}),e.jsx(r.Td,{style:{textAlign:"center"},children:m?e.jsx(P,{justify:"center",children:["ดีเยี่ยม","ดี","ผ่าน","ไม่ผ่าน","ขาดสอบ"].map(g=>e.jsx(re,{color:o[g],checked:t.values[p.student_id]?.result===g,onChange:()=>t.setFieldValue(`${p.student_id}.result`,g),label:g},g))}):e.jsx(L,{c:o[t.values[p.student_id]?.result],children:t.values[p.student_id]?.result})}),m?e.jsx(r.Td,{style:{maxWidth:"100px"},children:e.jsx(oe,{placeholder:"เลือกวันที่สอบ",valueFormat:"DD MMMM YYYY",value:t.values[p.student_id]?.date,onChange:g=>t.setFieldValue(`${p.student_id}.date`,g),clearable:!0})}):null]},p.student_id))));return e.jsxs(z,{children:[e.jsx(K,{opened:c.open,onClose:h,message:c.message,type:c.type}),e.jsx(L,{size:"1.5rem",fw:900,mb:"md",children:"กรอกผลการสอบวิทยานิพนธ์/การค้นคว้าอิสระ"}),k?e.jsxs("form",{onSubmit:i.onSubmit(W),children:[e.jsxs(P,{justify:"flex-end",children:[e.jsx(S,{color:"red",onClick:()=>{n(""),i.reset()},children:"ยกเลิก"}),e.jsx(S,{type:"submit",color:"green",children:"บันทึก"})]}),e.jsx(Y,{h:"md"}),e.jsx(H,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:8,border:"1px solid #e0e0e0"},children:e.jsxs(r,{highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสนักศึกษา"}),e.jsx(r.Th,{children:"ชื่อ"}),e.jsx(r.Th,{children:"ผลสอบ"}),e.jsx(r.Th,{children:"วันที่สอบ"})]})}),e.jsx(r.Tbody,{children:G(k,i,v,!0)})]})})]}):e.jsxs(z,{children:[e.jsx(P,{children:e.jsx(X,{placeholder:"เทอมการศึกษา",data:E,value:j,onChange:w})}),e.jsx(Y,{h:"md"}),e.jsx(H,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:8,border:"1px solid #e0e0e0"},children:e.jsxs(r,{highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสหมู่เรียน"}),e.jsx(r.Th,{children:"เทอมการศึกษา"}),e.jsx(r.Th,{children:"คำขอ"}),e.jsx(r.Th,{children:"ดำเนินการ"})]})}),e.jsx(r.Tbody,{children:Object.entries(O.filter(s=>!j||s.term===j).sort((s,t)=>C(t.term)-C(s.term)).reduce((s,t)=>{const o=`${t.study_group_id}-${t.term}`;return s[o]||(s[o]=[]),s[o].push(t),s},{})).map(([s,t])=>{const o=t.every(m=>m.exam_results!=null);return e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:t[0].study_group_id}),e.jsx(r.Td,{children:t[0].term}),e.jsx(r.Td,{children:[...new Set(t.map(m=>m.request_type))].join(", ")}),e.jsx(r.Td,{children:e.jsxs(P,{children:[e.jsx(S,{size:"xs",color:o?"yellow":"blue",onClick:()=>$(t),children:o?"แก้ไข":"กรอก"}),e.jsx(S,{size:"xs",onClick:()=>ne(t),children:"พิมพ์"}),e.jsx(S,{size:"xs",color:"teal",onClick:()=>V(t,`ผลสอบวิทยานิพนธ์_การค้นคว้าอิสระ_${t[0].study_group_id}.xlsx`),children:"Export Excel"})]})})]},s)})})]})})]}),e.jsxs(J,{opened:M,onClose:()=>T(!1),title:"รายชื่อนักเรียน",centered:!0,closeOnClickOutside:!1,children:[e.jsxs(r,{children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสนักเรียน"}),e.jsx(r.Th,{children:"ชื่อ-สกุล"}),e.jsx(r.Th,{style:{textAlign:"center"},children:"ผลสอบ"})]})}),e.jsx(r.Tbody,{children:G(k,i,v,!1)})]}),e.jsxs(P,{grow:!0,children:[e.jsx(S,{color:"yellow",onClick:()=>T(!1),children:"แก้ไข"}),e.jsx(S,{color:"green",onClick:q,children:"บันทึก"})]})]})]})};export{ye as default};
