import{t as i,j as e,B as R,T as A,D,E as $,A as r,M as L}from"./index-B7_hvkM2.js";import{M as U}from"./ModalInform-NNINQB9X.js";import{P as K}from"./PdfExamResultsPrint-DlwH8fCD.js";import{u as S,w as Q}from"./xlsx-mxuUxWRI.js";import{u as W}from"./use-form-DDBi_7fX.js";import{G as u}from"./Group-dxvsYpX2.js";import{S as B}from"./Space-CyCyKMgB.js";import{B as h}from"./Button-fInQYk36.js";import{C as X}from"./Checkbox-BOck0Pse.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./PdfUtils-2D7kTCyc.js";import"./dayjs.min-TNDP4t9g.js";const w="http://localhost:8080",he=()=>{const[f,b]=i.useState({open:!1,type:"",message:""}),p=(s,t)=>b({open:!0,type:s,message:t}),M=()=>b(s=>({...s,open:!1})),[z,m]=i.useState(!1),T=localStorage.getItem("token"),[F,I]=i.useState([]),[P,E]=i.useState(!1),[G,q]=i.useState([]),[j,k]=i.useState(""),[y,H]=i.useState(""),[_,g]=i.useState(""),x=W({}),C=s=>{const[t,o]=s.split("/").map(Number);return o*10+t},v={ผ่าน:"green",ไม่ผ่าน:"red",ขาดสอบ:"gray"};i.useEffect(()=>{(async()=>{try{const t=await fetch(`${w}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`}}),o=await t.json();if(!t.ok)throw new Error(o.message);I(o.map(n=>n.term));const l=new Date;let a=o.find(n=>{const c=new Date(n.term_open_date),d=new Date(n.term_close_date);return l>=c&&l<=d});!a&&o.length>0&&(a=[...o].sort((n,c)=>new Date(c.term_close_date)-new Date(n.term_close_date))[0]),a&&k(a.term)}catch(t){p("error",t.message)}})()},[]),i.useEffect(()=>{(async()=>{try{const t=await fetch(`${w}/api/AllExamResults`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`}}),o=await t.json();if(!t.ok)throw new Error(o.message);q(o)}catch(t){p("error",t.message)}E(!1)})()},[P]);const N=s=>{const t=s[0].study_group_id,o=s[0].term;g({[t]:{[o]:s}});const l={};s.forEach(a=>{l[a.student_id]=a.exam_results??"ผ่าน"}),x.setValues(l)},V=async()=>{try{const s=await fetch(`${w}/api/AddExamResults`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`},body:JSON.stringify({...x.values,term:j})}),t=await s.json();if(!s.ok)throw new Error(t.message);p("success",t.message),m(!1),E(!0),g("")}catch(s){p("error",s.message)}},J=(s,t="ผลการสอบ.xlsx")=>{const o=s.map(n=>({รหัสนักศึกษา:n.student_id,"ชื่อ-สกุล":n.name,ผลสอบ:n.exam_results,หมู่เรียน:n.study_group_id,เทอม:n.term})),l=S.json_to_sheet(o),a=S.book_new();S.book_append_sheet(a,l,"ผลการสอบ"),Q(a,t)},O=(s,t,o,l=!1)=>Object.values(s).flatMap(a=>Object.values(a).flatMap(n=>n.map(c=>e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:c.student_id}),e.jsx(r.Td,{children:c.name}),e.jsx(r.Td,{style:{textAlign:"center"},children:l?e.jsx(u,{justify:"center",children:["ผ่าน","ไม่ผ่าน","ขาดสอบ"].map(d=>e.jsx(X,{color:o[d],checked:t.values[c.student_id]===d,onChange:()=>t.setFieldValue(c.student_id,d),label:d},d))}):e.jsx(A,{c:o[t.values[c.student_id]],children:t.values[c.student_id]})})]},c.student_id))));return e.jsxs(R,{children:[e.jsx(U,{opened:f.open,onClose:M,message:f.message,type:f.type}),e.jsx(A,{size:"1.5rem",fw:900,mb:"md",children:"กรอกผลการสอบประมวลความรู้/สอบวัดคุณสมบัติ"}),_?e.jsxs("form",{onSubmit:x.onSubmit(()=>m(!0)),children:[e.jsxs(u,{justify:"flex-end",children:[e.jsx(h,{color:"red",onClick:()=>g(""),children:"ยกเลิก"}),e.jsx(h,{type:"submit",color:"green",children:"บันทึก"})]}),e.jsx(B,{h:"md"}),e.jsx($,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:8,border:"1px solid #e0e0e0"},children:e.jsxs(r,{highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสนักศึกษา"}),e.jsx(r.Th,{children:"ชื่อ"}),e.jsx(r.Th,{children:"ผลสอบ"})]})}),e.jsx(r.Tbody,{children:O(_,x,v,!0)})]})})]}):e.jsxs(R,{children:[e.jsxs(u,{children:[e.jsx(D,{placeholder:"ชนิดคำขอ",data:["ขอสอบประมวลความรู้","ขอสอบวัดคุณสมบัติ"],value:y,onChange:H}),e.jsx(D,{placeholder:"เทอมการศึกษา",data:F,value:j,onChange:k})]}),e.jsx(B,{h:"md"}),e.jsx($,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:8,border:"1px solid #e0e0e0"},children:e.jsxs(r,{highlightOnHover:!0,children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสหมู่เรียน"}),e.jsx(r.Th,{children:"เทอมการศึกษา"}),e.jsx(r.Th,{children:"คำขอ"}),e.jsx(r.Th,{children:"ดำเนินการ"})]})}),e.jsx(r.Tbody,{children:Object.entries(G.filter(s=>(!j||s.term===j)&&(!y||s.request_type===y)).sort((s,t)=>C(t.term)-C(s.term)).reduce((s,t)=>{const o=`${t.study_group_id}-${t.term}`;return s[o]||(s[o]=[]),s[o].push(t),s},{})).map(([s,t])=>{const o=t.every(l=>l.exam_results!=null);return e.jsxs(r.Tr,{children:[e.jsx(r.Td,{children:t[0].study_group_id}),e.jsx(r.Td,{children:t[0].term}),e.jsx(r.Td,{children:[...new Set(t.map(l=>l.request_type))].join(", ")}),e.jsx(r.Td,{children:e.jsxs(u,{children:[e.jsx(h,{size:"xs",color:o?"yellow":"blue",onClick:()=>N(t),children:o?"แก้ไข":"กรอก"}),e.jsx(h,{size:"xs",onClick:()=>K(t),children:"พิมพ์"}),e.jsx(h,{size:"xs",color:"teal",onClick:()=>J(t,`ผลการสอบประมวลความรู้_วัดคุณสมบัติ_${t[0].study_group_id}.xlsx`),children:"Export Excel"})]})})]},s)})})]})})]}),e.jsxs(L,{opened:z,onClose:()=>m(!1),title:"รายชื่อนักเรียน",centered:!0,closeOnClickOutside:!1,children:[e.jsxs(r,{children:[e.jsx(r.Thead,{children:e.jsxs(r.Tr,{children:[e.jsx(r.Th,{children:"รหัสนักเรียน"}),e.jsx(r.Th,{children:"ชื่อ-สกุล"}),e.jsx(r.Th,{style:{textAlign:"center"},children:"ผลสอบ"})]})}),e.jsx(r.Tbody,{children:O(_,x,v,!1)})]}),e.jsxs(u,{grow:!0,children:[e.jsx(h,{color:"yellow",onClick:()=>m(!1),children:"แก้ไข"}),e.jsx(h,{color:"green",onClick:()=>(m(!1),V()),children:"บันทึก"})]})]})]})};export{he as default};
