import{t as o,j as s,M as ue,v as h,A as c,T as P,B as I,D as he,E as pe}from"./index-B7_hvkM2.js";import{G as O}from"./Grid-C85KIsm1.js";import{S as V}from"./Space-CyCyKMgB.js";import{F as H}from"./Flex-CXnzITNo.js";import{B as y}from"./Button-fInQYk36.js";import{M as fe}from"./ModalApprove-GxzTwETF.js";import{M as me}from"./ModalPay-B7m0CAUf.js";import{M as xe}from"./ModalInform-NNINQB9X.js";import{P as ge}from"./Pdfg03-04-Eg6H1Izd.js";import{j as je}from"./index-VWaDGczM.js";import{u as _e}from"./use-form-DDBi_7fX.js";import{S as W}from"./Stepper-B-uTcAaD.js";import{P as A}from"./Pill-B7ktLfj6.js";import{G as U}from"./Group-dxvsYpX2.js";import"./get-sorted-breakpoints-BmTdo-hw.js";import"./Checkbox-BOck0Pse.js";import"./Image-QhnbGiva.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./PdfUtils-2D7kTCyc.js";import"./dayjs.min-TNDP4t9g.js";const ye="http://localhost:8080",Te=({opened:i,onClose:g,title:l,form:d,handleAdd:T})=>{const[u,E]=o.useState([]),S=localStorage.getItem("token");return o.useEffect(()=>{i&&(async()=>{try{const f=await fetch(`${ye}/api/getAdvisors`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`}}),m=await f.json();if(!f.ok)throw new Error(m.message);E(m.map(w=>({value:w.user_id,label:w.name})))}catch(f){console.error("Error fetching advisors:",f)}})()},[i,S]),s.jsx(ue,{opened:i,onClose:g,title:l,centered:!0,size:"800",children:s.jsxs("form",{onSubmit:d.onSubmit(T),children:[s.jsxs(O,{breakpoints:{md:"660px"},children:[s.jsxs(O.Col,{span:{base:12,md:6},children:[s.jsx(h,{label:"ชื่อ-นามสกุล",disabled:!0,...d.getInputProps("student_name")}),s.jsx(h,{label:"รหัสประจำตัว",disabled:!0,...d.getInputProps("student_id")}),s.jsx(h,{label:"ระดับการศึกษา",disabled:!0,...d.getInputProps("education_level")}),s.jsx(h,{label:"หลักสูตร",disabled:!0,...d.getInputProps("program")}),s.jsx(h,{label:"สาขาวิชา",disabled:!0,...d.getInputProps("major_name")}),s.jsx(h,{label:"คณะ",disabled:!0,...d.getInputProps("faculty_name")})]}),s.jsxs(O.Col,{span:{base:12,md:6},children:[s.jsx(h,{label:"อาจารย์ที่ปรึกษางานวิจัย",disabled:!0,...d.getInputProps("thesis_advisor_name")}),s.jsx(h,{label:"ชื่องานวิจัย",placeholder:"กรอกชื่องานวิจัย",...d.getInputProps("research_name")})]})]}),s.jsx(V,{h:"lg"}),s.jsx(H,{justify:"flex-end",children:s.jsx(y,{type:"submit",color:"green",children:"บันทึก"})})]})})},p="http://localhost:8080",We=()=>{const i=localStorage.getItem("token"),g=je(i),l=g.role;g.user_id,console.log("token :",g);const[d,T]=o.useState({open:!1,type:"",message:""}),u=(e,t)=>T({open:!0,type:e,message:t}),E=()=>T(e=>({...e,open:!1})),[S,v]=o.useState(!1),[f,m]=o.useState(!1),[w,K]=o.useState(!1),[Q,D]=o.useState(!1),[z,B]=o.useState(null),[C,N]=o.useState("approve"),[k,M]=o.useState(""),[X,Y]=o.useState(""),[L,Z]=o.useState(""),[F,b]=o.useState([]),[G,ee]=o.useState(""),j=_e({initialValues:{student_name:"",student_id:"",education_level:"",program:"",major_name:"",faculty_name:"",thesis_exam_date:null},validate:{research_name:e=>e===""?"กรุณากรอกชื่องานวิจัย":null}}),[se,te]=o.useState([]),[re,J]=o.useState("");o.useEffect(()=>{(async()=>{try{const r=await fetch(`${p}/api/profile`,{method:"GET",headers:{Authorization:`Bearer ${i}`}}),a=await r.json();if(!r.ok)throw new Error(a.message);Z(a),console.log(a)}catch(r){u("error",r.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching profile:",r)}})(),(async()=>{try{const r=await fetch(`${p}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),a=await r.json();if(!r.ok)throw new Error(a.message);te(a.map(x=>x.term)),console.log(a);const n=new Date;let _=a.find(x=>{const $=new Date(x.term_open_date),de=new Date(x.term_close_date);return n>=$&&n<=de});!_&&a.length>0&&(_=[...a].sort((x,$)=>new Date($.term_close_date)-new Date(x.term_close_date))[0]),J(_.term)}catch(r){u("error",r.message),console.error("Error fetching allRequestExamInfo:",r)}})()},[i]);const[q,R]=o.useState(null);o.useEffect(()=>{(async()=>{try{const t=await fetch(`${p}/api/allRequestThesisDefense`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),r=await t.json();if(!t.ok)throw new Error(r.message);b(r);const a=await fetch(`${p}/api/allRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({lastRequest:!0})}),n=await a.json();if(!a.ok)throw new Error(n.message);console.log(n),console.log(r),n[0]?.status==="5"&&n[0]?.exam_results==="ผ่าน"&&(r[0]?.status==="6"||r[0]?.status===void 0)?R(!1):R(!0)}catch(t){u("error",t.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching allRequestThesisDefense:",t)}})()},[]);const ae=async()=>{try{const e=await fetch(`${p}/api/allRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({lastRequest:!0})}),t=await e.json();if(!e.ok)throw new Error(t.message);console.log(t[0]),j.setValues(t[0]),j.setValues({thesis_exam_date:null}),v(!0)}catch(e){u("error",e.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching studentInfo:",e)}},oe=async()=>{try{const e=await fetch(`${p}/api/addRequestThesisDefense`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(j.values)}),t=await e.json();if(!e.ok)throw new Error(t.message);u("success",t.message||"สำเร็จ"),v(!1),b(r=>[...r,{...j.values,...t.data}]),R(!0)}catch(e){u("error",e.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching addRequestThesisDefense:",e)}},ne=async e=>{if(C==="noapprove"&&k.trim()===""){Y("กรุณาระบุเหตุผล");return}try{const t=await fetch(`${p}/api/approveRequestThesisDefense`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({request_thesis_defense_id:e.request_thesis_defense_id,name:L.name,role:l,selected:C,comment:k})}),r=await t.json();if(!t.ok)throw new Error(r.message);u("success",r.message||"สำเร็จ"),N("approve"),M(""),m(!1),b(a=>a.map(n=>n.request_thesis_defense_id===e.request_thesis_defense_id?{...n,...r.data}:n))}catch(t){u("error",t.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching approveRequestThesisDefense:",t)}},le=async e=>{try{const t=await fetch(`${p}/api/payRequestThesisDefense`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({request_thesis_defense_id:e.request_thesis_defense_id,receipt_vol:"154",receipt_No:"4",receipt_pay:"1000"})}),r=await t.json();if(!t.ok)throw new Error(r.message);u("success",r.message||"สำเร็จ"),D(!1),b(a=>a.map(n=>n.request_thesis_defense_id===e.request_thesis_defense_id?{...n,...r.data}:n))}catch(t){u("error",t.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching payRequestThesisDefense:",t)}};function ce(e,t){return t==="student"?e:e.sort((r,a)=>{const n=Number(r.status)===0?1:0,_=Number(a.status)===0?1:0;return n-_||Number(r.status)-Number(a.status)})}const ie=ce(F,l).filter(e=>[e.student_name,e.student_id].join(" ").toLowerCase().includes(G.toLowerCase())).map(e=>s.jsxs(c.Tr,{children:[s.jsx(c.Td,{children:e.student_name}),s.jsx(c.Td,{children:e.request_type}),s.jsxs(c.Td,{style:{textAlign:"center"},children:[e.status<=4&&e.status>0&&s.jsx(W,{active:e.status-1,iconSize:20,styles:{separator:{marginLeft:-4,marginRight:-4},stepIcon:{fontSize:10}},children:[...Array(4)].map((t,r)=>s.jsx(W.Step,{children:s.jsx(A,{children:e.status_text})},r))}),(e.status==0||e.status>6)&&s.jsx(A,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),e.status==5&&s.jsx(A,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:e.status_text}),e.status==6&&s.jsxs(s.Fragment,{children:[s.jsx(A,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),s.jsx("br",{}),!e.advisor_approvals&&"อาจารย์ที่ปรึกษา",e.advisor_approvals&&!e.chairpersons_approvals&&"ประธานหลักสูตร",e.advisor_approvals&&e.chairpersons_approvals&&!e.registrar_approvals&&"เจ้าหน้าที่ทะเบียน"]})]}),s.jsx(c.Td,{style:{maxWidth:"150px"},children:s.jsxs(U,{children:[l==="student"&&s.jsxs(s.Fragment,{children:[e.status==="4"&&s.jsx(y,{size:"xs",color:"green",onClick:()=>{B(e),D(!0)},children:"ชำระค่าธรรมเนียม"}),(e.status==5||e.status==0||e.status>6)&&s.jsx(y,{size:"xs",color:"green",children:"พิมพ์ใบเสร็จ"})]}),s.jsx(ge,{data:e,showType:e.status==0?void 0:l==="advisor"&&e.status<=1||l==="chairpersons"&&e.status<=2||l==="officer_registrar"&&e.status<=3?"view":void 0}),(l==="research_advisor"&&e.status==1||l==="chairpersons"&&e.status==2||l==="officer_registrar"&&e.status==3)&&s.jsx(y,{size:"xs",color:"green",onClick:()=>{B(e),K("add"),m(!0)},children:l==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"})]})}),e.exam_results!==null&&s.jsxs(c.Td,{style:{textAlign:"center"},children:[e.exam_results==="ผ่าน"&&s.jsx(P,{c:"green",children:"ผ่าน"}),e.exam_results==="ไม่ผ่าน"&&s.jsx(P,{c:"red",children:"ไม่ผ่าน"}),e.exam_results==="ขาดสอบ"&&s.jsx(P,{c:"gray",children:"ขาดสอบ"})]})]},e.request_thesis_defense_id));return s.jsxs(I,{children:[s.jsx(xe,{opened:d.open,onClose:E,message:d.message,type:d.type}),s.jsx(fe,{opened:f,onClose:()=>m(!1),selectedRow:z,selected:C,setSelected:N,comment:k,setComment:M,error:X,openApproveState:w,handleApprove:ne,role:l,title:`${l==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"}คำร้องขอสอบ${L.education_level==="ปริญญาโท"?"วิทยานิพนธ์":"การค้นคว้าอิสระ"}`}),s.jsx(Te,{opened:S,onClose:()=>v(!1),form:j,handleAdd:oe,title:"เพิ่มคำร้องขอสอบวิทยานิพนธ์/การค้นคว้าอิสระ"}),s.jsx(me,{opened:Q,onClose:()=>D(!1),selectedRow:z,handlePay:le}),s.jsx(P,{size:"1.5rem",fw:900,mb:"md",children:"คำร้องขอสอบวิทยานิพนธ์/การค้นคว้าอิสระ"}),s.jsxs(U,{justify:"space-between",children:[s.jsx(I,{children:s.jsxs(H,{align:"flex-end",gap:"sm",children:[l!=="student"&&s.jsx(h,{placeholder:"ค้นหาชื่่อ รหัส",value:G,onChange:e=>ee(e.target.value)}),s.jsx(he,{placeholder:"เทอมการศึกษา",data:se,value:re,onChange:J,allowDeselect:!1})]})}),s.jsx(I,{children:l==="student"&&s.jsx(y,{onClick:()=>ae(),disabled:q?q.status!=="0"&&q.status!=="6"&&q.exam_results!==!1:!1,children:"เพิ่มคำร้อง"})})]}),s.jsx(V,{h:"md"}),s.jsx(pe,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:s.jsxs(c,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[s.jsx(c.Thead,{children:s.jsxs(c.Tr,{children:[s.jsx(c.Th,{style:{minWidth:100},children:"ชื่อ"}),s.jsx(c.Th,{style:{minWidth:100},children:"เรื่อง"}),s.jsx(c.Th,{style:{minWidth:110},children:"สถานะ"}),s.jsx(c.Th,{children:"การดำเนินการ"}),F.some(e=>e.exam_results!==null)&&s.jsx(c.Th,{style:{minWidth:110},children:"ผลสอบ"})]})}),s.jsx(c.Tbody,{children:ie})]})})]})};export{We as default};
