import{j as a,t as w,B as C,T as z,D as A,E as Q,A as l}from"./index-B7_hvkM2.js";import{P as N,f as v,a as U,d as g,e as L,h as B,i as S,j as F}from"./PdfUtils-2D7kTCyc.js";import{B as H}from"./Button-fInQYk36.js";import{M as W}from"./ModalInform-NNINQB9X.js";import{G}from"./Group-dxvsYpX2.js";import{S as X}from"./Space-CyCyKMgB.js";import"./dayjs.min-TNDP4t9g.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";const Y="http://localhost:8080";async function V(j,x){const T=await fetch(j).then(r=>r.arrayBuffer()),_=await N.load(T);_.registerFontkit(v);const u=await N.create();u.registerFontkit(v);const $=await fetch("/fonts/THSarabunNew.ttf").then(r=>r.arrayBuffer()),o=await u.embedFont($),I=await fetch("/icons/KPRU-LOGO-line2.png").then(r=>r.arrayBuffer()),R=await u.embedPng(I),i=R.scale(.125),b=Object.values(x)[0]?.[0]?.term;let d=null;try{const r=localStorage.getItem("token"),s=await(await fetch(`${Y}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({term:b})})).json();Array.isArray(s)&&s.length>0&&(d=s[0]),console.log(d)}catch(r){console.error("Error fetch allRequestExamInfo:",r)}const m=[];if(d&&d.KQ_exam_date&&d.KQ_exam_end_date){const r=new Date(d.KQ_exam_date),t=new Date(d.KQ_exam_end_date);let s=new Date(r.getTime());for(;s<=t;)m.push(new Date(s)),s.setDate(s.getDate()+1)}else d&&d.KQ_exam_date&&m.push(new Date(d.KQ_exam_date));m.length===0&&m.push(null);const E=25,n=20;for(const r in x){const t=x[r];for(const s of m){let h;if(s){const[e,f,y]=U(s);h=`สอบวันที่ ${e} ${f} ${y} เวลา............................`}else h="สอบวันที่ ........................................ เวลา............................";let p=0;for(;p*E<t.length;){const[e]=await u.copyPages(_,[0]);u.addPage(e);const f=p*E,y=Math.min(f+E,t.length),K=(e.getWidth()-i.width)/2;e.drawImage(R,{x:K,y:700,width:i.width,height:i.height});const k=t[0].request_type.split("ขอ")[1];let c;k==="สอบประมวลความรู้"?(g(e,`รายชื่อผู้เข้า${k}`,680,o,16),g(e,`ประจำภาคเรียนที่ ${t[0].term}`,660,o,16),g(e,"หมวด..........................................",640,o,16),g(e,h,620,o,16),c=580):(g(e,`รายชื่อผู้เข้า${k}`,680,o,16),g(e,"ด้าน..................................................",660,o,16),g(e,`ปรัชญาดุษฎีบัณฑิต สาขาวิชา${t[0].major_name} รุ่นที่ ${parseInt(t[0].id.slice(0,2),10)-57}`,640,o,16),g(e,"มหาวิทยาลัยราชภัฏกําแพงเพชร",620,o,16),g(e,h,600,o,16),c=560),L(e,60,c,490,n);const M=(y-f)*n,q=c-M;B(e,100,c+n,100,q),B(e,170,c+n,170,q),B(e,370,c+n,370,q),B(e,470,c+n,470,q),S(e,"ลำดับ",60,c,40,n,o,14),S(e,"รหัสนักศึกษา",100,c,70,n,o,14),S(e,"ชื่อ - นามสกุล",170,c,200,n,o,14),S(e,"ลายมือชื่อ",370,c,100,n,o,14),S(e,"หมายเหตุ",470,c,80,n,o,14);for(let D=f;D<y;D++)c-=n,L(e,60,c,490,n),S(e,`${D+1}`,60,c,40,n,o,14),S(e,`${t[D].id}`,100,c,70,n,o,14),F(e,t[D].name.split(" ")[0],190,c,n,o,14),F(e,t[D].name.split(" ").slice(1).join(" "),290,c,n,o,14);p++}}}const O=await u.save();return new Blob([O],{type:"application/pdf"})}function Z({data:j}){const x=async()=>{const T=await V("/pdf/blank.pdf",j),_=URL.createObjectURL(T);window.open(_,"_blank")};return a.jsxs(H,{size:"xs",color:"gray",onClick:x,children:["พิมพ์รายชื่อ"," "]})}const J="http://localhost:8080",ie=()=>{const[j,x]=w.useState({open:!1,type:"",message:""}),T=(r,t)=>x({open:!0,type:r,message:t}),_=()=>x(r=>({...r,open:!1})),u=localStorage.getItem("token"),[$,o]=w.useState([]),[I,R]=w.useState([]),[i,P]=w.useState(""),[b,d]=w.useState(""),[m,E]=w.useState(JSON.stringify([5])),n=[{value:JSON.stringify([5]),label:"อนุญาต"},{value:JSON.stringify([6]),label:"ไม่อนุญาต"},{value:JSON.stringify([1,2,3,4]),label:"กำลังดำเนินการ"}];w.useEffect(()=>{(async()=>{try{const t=await fetch(`${J}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`}}),s=await t.json();if(!t.ok)throw new Error(s.message);o(s.map(e=>e.term)),console.log(s);const h=new Date;let p=s.find(e=>{const f=new Date(e.term_open_date),y=new Date(e.term_close_date);return h>=f&&h<=y});!p&&s.length>0&&(p=[...s].sort((e,f)=>new Date(f.term_close_date)-new Date(e.term_close_date))[0]),p?P(p.term):console.warn("ไม่พบข้อมูลเทอม")}catch(t){T("error",t.message),console.error("Error fetching allRequestExamInfo:",t)}})()},[]),w.useEffect(()=>{if(!i)return;console.log(i),(async()=>{try{const t=await fetch(`${J}/api/allExamEligibleListPrint`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({term:i})}),s=await t.json();if(!t.ok)throw new Error(s.message);R(s),console.log("all request :",s)}catch(t){T("error",t.message),console.error("Error fetching allExamEligibleListPrint:",t)}})()},[i]);const O=(()=>{let r=null;if(m)try{r=JSON.parse(m)}catch(t){console.error("Error parsing selectedStatus:",t)}return!b&&!i&&!m?I:Object.fromEntries(Object.entries(I).map(([t,s])=>[t,s.filter(h=>{const p=parseInt(h.status,10),e=!i||h.term===i,f=!b||h.request_type===b,y=!m||r&&r.includes(p);return e&&f&&y})]).filter(([t,s])=>s.length>0))})();return a.jsxs(C,{children:[a.jsx(W,{opened:j.open,onClose:_,message:j.message,type:j.type}),a.jsx(z,{size:"1.5rem",fw:900,mb:"md",children:"พิมพ์ใบรายชื่อผู้มีสิทธิสอบประมวลความรู้/สอบวัดคุณสมบัติ"}),a.jsxs(G,{justify:"space-between",children:[a.jsxs(G,{children:[a.jsx(A,{placeholder:"ชนิดคำขอ",data:["ขอสอบประมวลความรู้","ขอสอบวัดคุณสมบัติ"],value:b,onChange:d}),a.jsx(A,{placeholder:"เทอมการศึกษา",data:$,value:i,allowDeselect:!1,onChange:P}),a.jsx(A,{placeholder:"สถานะ",data:n,value:m,onChange:E})]}),a.jsx(C,{children:a.jsx(Z,{data:O})})]}),a.jsx(X,{h:"md"}),a.jsx(Q,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:a.jsxs(l,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[a.jsx(l.Thead,{children:a.jsxs(l.Tr,{children:[a.jsx(l.Th,{children:"เทอมการศึกษา"}),a.jsx(l.Th,{children:"ชื่อ"}),a.jsx(l.Th,{children:"คำขอ"}),a.jsx(l.Th,{children:"สถานะ"})]})}),a.jsx(l.Tbody,{children:Object.entries(O).map(([r,t])=>t.map(s=>a.jsxs(l.Tr,{children:[a.jsx(l.Td,{children:s.term}),a.jsx(l.Td,{children:s.name}),a.jsx(l.Td,{children:s.request_type}),a.jsx(l.Td,{children:s.status_text})]},s.id)))})]})})]})};export{ie as default};
