import{j as r,t as p,A as u,T as te,B as X,v as ye,D as _e,E as fe}from"./index-B7_hvkM2.js";import{M as de}from"./ModalApprove-GxzTwETF.js";import{M as me}from"./ModalAdd-CclXvU2L.js";import{M as ve}from"./ModalPay-B7m0CAUf.js";import{M as ge}from"./ModalInform-NNINQB9X.js";import{P as we,f as be,s as je,a as se,b as N,d as Se,c as Te,e as F}from"./PdfUtils-2D7kTCyc.js";import{B as S}from"./Button-fInQYk36.js";import{j as qe}from"./index-VWaDGczM.js";import{u as Ee}from"./use-form-DDBi_7fX.js";import{S as oe}from"./Stepper-B-uTcAaD.js";import{P as L}from"./Pill-B7ktLfj6.js";import{G as re}from"./Group-dxvsYpX2.js";import{F as Re}from"./Flex-CXnzITNo.js";import{S as Oe}from"./Space-CyCyKMgB.js";import"./Checkbox-BOck0Pse.js";import"./Image-QhnbGiva.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./dayjs.min-TNDP4t9g.js";const ae="http://localhost:8080";async function ne(e){const _=await we.create();_.registerFontkit(be);const l=_.addPage([595,842]);await je(_);const T=await fetch("/fonts/THSarabunNew Bold.ttf").then(i=>i.arrayBuffer()),h=await _.embedFont(T);let d;try{const i=localStorage.getItem("token"),x=await(await fetch(`${ae}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({term:e?.term})})).json();Array.isArray(x)&&x.length>0&&(d=x[0].ET_exam_date,e.term=x[0].term)}catch(i){console.error("Error fetch allRequestExamInfo:",i)}const c=localStorage.getItem("token"),M={advisor:"advisor_approvals_id",chairpersons:"chairpersons_approvals_id",registrar:"registrar_approvals_id"};try{for(const[i,A]of Object.entries(M)){const x=e?.[A];if(!x||isNaN(Number(x)))continue;const G=await fetch(`${ae}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({user_id:x})}),m=await res.json();m&&(e[A]=m.name)}}catch(i){console.error("Error fetch personnelInfo:",i)}const[$,w,C]=se(e?.request_date),[q,J,K]=se(d),[Q,E,k]=N(e?.advisor_approvals_date),[D,R,B]=N(e?.chairpersons_approvals_date),[O,P,U]=N(e?.registrar_approvals_date),[W,z,H]=N(e?.receipt_pay_date);let t=760,o=20;Se(l,"คำร้องขอทดสอบความรู้ทางภาษาอังกฤษ",780,h,20),[{text:"มหาวิทยาลัยราชภัฏกำแพงเพชร",x:420,y:t-=o},{text:"วันที่................เดือน...........................พ.ศ...................",x:350,y:t-=o},{text:$,x:380,y:t+2},{text:w,x:440,y:t+2},{text:C,x:510,y:t+2},{text:"เรื่อง",x:60,y:t-=o*2,font:h},{text:"ขอทดสอบความรู้ทางภาษาอังกฤษสำหรับนักศึกษาระดับดุษฎีบัณฑิต",x:100,y:t},{text:"เรียน",x:60,y:t-=o,font:h},{text:`อธิการบดีมหาวิทยาลัยราชภัฏกำแพงเพชร${e?.major_name}`,x:100,y:t},{text:"ข้าพเจ้า................................................................................................รหัสประจำตัวนักศึกษา.................................................",x:100,y:t-=o*2},{text:e?.student_name,x:180,y:t+2},{text:e?.student_id,x:460,y:t+2},{text:"ระดับ...........................................หลักสูตร...............................................................................สาขาวิชา....................................................",x:60,y:t-=o},{text:e?.education_level,x:110,y:t+2},{text:e?.program,x:230,y:t+2},{text:e?.major_name,x:440,y:t+2},{text:"คณะ.................................................................................มีความประสงค์จะขอทดสอบความรู้ภาษาอังกฤษสำหรับนักศึกษาดุษฎีบัณฑิต",x:60,y:t-=o},{text:e?.faculty_name,x:100,y:t+2},{text:"ในภาคเรียนที่ .........................ในวันที่.....................................................",x:60,y:t-=o},{text:e?.term,x:130,y:t+2},{text:`${q} ${J} ${K}`,x:210,y:t+2},{text:"จึงเรียนมาเพื่อโปรดพิจารณา",x:100,y:t-=o},{text:"ลงชื่อ...........................................................................",x:310,y:t-=o*2},{text:e?.student_name,x:370,y:t+2},{text:"(.........................................................................)",x:330,y:t-=o},{text:e?.student_name,x:370,y:t+2},{text:"นักศึกษา",x:400,y:t-=o},{text:"วันที่................/........................../......................",x:330,y:t-=o},{text:$,x:360,y:t+2},{text:w,x:400,y:t+2},{text:C,x:465,y:t+2},{text:"1. ความเห็นของอาจารย์ที่ปรึกษาหมู่เรียน",x:60,y:t-=o*2,font:h,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals?"เห็นควรอนุญาต":"ไม่อนุญาต",x:80,y:t-=o,show:typeof e?.advisor_approvals=="boolean"},{text:`เนื่องจาก ${e?.comment}`,x:80,y:t-=o,show:typeof e?.advisor_approvals=="boolean"&&!e.advisor_approvals},{text:"ลงชื่อ.......................................................................",x:75,y:t-=o*2,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals_id,x:140,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"(.....................................................................) ",x:95,y:t-=o,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals_id,x:140,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"อาจารย์ที่ปรึกษา",x:145,y:t-=o,show:typeof e?.advisor_approvals=="boolean"},{text:"วันที่ ........../................./...................",x:110,y:t-=o,show:typeof e?.advisor_approvals=="boolean"},{text:Q,x:135,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:E,x:170,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:k,x:210,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"2. ความเห็นประธานกรรมการบัณฑิตศึกษาประจำสาขาวิชา",x:310,y:t+=o*7,font:h,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals?"เห็นควรอนุญาต":"ไม่อนุญาต",x:330,y:t-=o,show:typeof e?.chairpersons_approvals=="boolean"},{text:`เนื่องจาก ${e?.comment}`,x:330,y:t-=o,show:typeof e?.chairpersons_approvals=="boolean"&&!e.chairpersons_approvals},{text:"ลงชื่อ.......................................................................",x:325,y:t-=o*2,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals_id,x:390,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:"(.....................................................................) ",x:345,y:t-=o,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals_id,x:390,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:"ประธานกรรมการบัณฑิตศึกษาประจำสาขาวิชา",x:340,y:t-=o,show:typeof e?.chairpersons_approvals=="boolean"},{text:"วันที่ ........../................./...................",x:360,y:t-=o,show:typeof e?.chairpersons_approvals=="boolean"},{text:D,x:385,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:R,x:420,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:B,x:460,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:"3. การตรวจสอบของสำนักส่งเสริมวิชาการและงานทะเบียน",x:60,y:t-=o*1.5,font:h,show:typeof e?.registrar_approvals=="boolean"},{text:e?.registrar_approvals?`มีสภาพการเป็นนักศึกษา ภาคเรียนที่ ${e?.term}`:"ไม่อนุญาต",x:80,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:e?.registrar_approvals?"ลงทะเบียนเรียนครบตามหลักสูตร":`เนื่องจาก ${e?.comment}`,x:80,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:"ให้ชำระค่าธรรมเนียมที่ฝ่ายการเงิน",x:60,y:t-=o,show:typeof e?.registrar_approvals=="boolean"&&e?.registrar_approvals},{text:"ลงชื่อ.......................................................................",x:75,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:e?.registrar_approvals_id,x:140,y:t+2,show:typeof e?.registrar_approvals=="boolean"},{text:"(.....................................................................) ",x:95,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:e?.registrar_approvals_id,x:140,y:t+2,show:typeof e?.registrar_approvals=="boolean"},{text:"นายทะเบียน",x:150,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:"วันที่ ........../................./...................",x:110,y:t-=o,show:typeof e?.registrar_approvals=="boolean"},{text:O,x:135,y:t+2,show:typeof e?.registrar_approvals=="boolean"},{text:P,x:170,y:t+2,show:typeof e?.registrar_approvals=="boolean"},{text:U,x:210,y:t+2,show:typeof e?.registrar_approvals=="boolean"},{text:`4. ชำระค่าธรรมเนียมการสอบแล้ว ภาคเรียนที่ ${e?.term}`,x:310,y:t+=o*7,font:h,show:e?.receipt_vol!==null},{text:"จำนวน 1,000 บาท (หนึ่งพันบาทถ้วน)",x:330,y:t-=o,show:e?.receipt_vol!==null},{text:`ตามใบเสร็จรับเงิน เล่มที่ ${e?.receipt_vol} เลขที่ ${e?.receipt_vol}`,x:310,y:t-=o,show:e?.receipt_vol!==null},{text:"ลงชื่อ.......................................................................",x:325,y:t-=o*2,show:e?.receipt_vol!==null},{text:"นายณัฐวุฒิ มาตกาง",x:390,y:t+2,show:e?.receipt_vol!==null},{text:"(.....................................................................) ",x:345,y:t-=o,show:e?.receipt_vol!==null},{text:"นายณัฐวุฒิ มาตกาง",x:390,y:t+2,show:e?.receipt_vol!==null},{text:"เจ้าหน้าที่การเงิน",x:395,y:t-=o,show:e?.receipt_vol!==null},{text:"วันที่ ........../................./...................",x:360,y:t-=o,show:e?.receipt_vol!==null},{text:W,x:385,y:t+2,show:e?.receipt_vol!==null},{text:z,x:420,y:t+2,show:e?.receipt_vol!==null},{text:H,x:460,y:t+2,show:e?.receipt_vol!==null}].filter(i=>i.show!==!1).forEach(i=>Te(l,i.text,i.x,i.y,i.font,i.size)),typeof e?.advisor_approvals=="boolean"&&F(l,50,t+o*8,250,o*8.5),typeof e?.chairpersons_approvals=="boolean"&&F(l,300,t+o*8,250,o*8.5),typeof e?.registrar_approvals=="boolean"&&F(l,50,t-o*.5,250,o*8.5),e?.receipt_vol!==null&&F(l,300,t-o*.5,250,o*8.5);const b=await _.save();return new Blob([b],{type:"application/pdf"})}function Ae({data:e,showType:_}){const l=async()=>{const h=await ne(e),d=URL.createObjectURL(h);window.open(d,"_blank")},T=async()=>{const h=await ne(e),d=URL.createObjectURL(h),c=document.createElement("iframe");c.style.display="none",c.src=d,document.body.appendChild(c),c.onload=()=>{c.contentWindow.print()}};return r.jsx(r.Fragment,{children:_==="view"?r.jsx(S,{size:"xs",color:"gray",onClick:l,children:"ข้อมูล"}):r.jsx(S,{size:"xs",color:"blue",onClick:T,children:"พิมพ์"})})}const g="http://localhost:8080",Ye=()=>{const e=localStorage.getItem("token"),_=p.useMemo(()=>qe(e),[e]),l=_.role,T=_.name,[h,d]=p.useState({open:!1,type:"",message:""}),c=(s,a)=>d({open:!0,type:s,message:a}),M=()=>d(s=>({...s,open:!1})),[$,w]=p.useState(!1),[C,q]=p.useState(!1),[J,K]=p.useState(!1),[Q,E]=p.useState(!1),[k,D]=p.useState(null),[R,B]=p.useState("approve"),[O,P]=p.useState(""),[U,W]=p.useState(""),[z,H]=p.useState(""),[t,o]=p.useState(!0),[f,b]=p.useState(null),[i,A]=p.useState([]),[x,G]=p.useState(""),[m,Y]=p.useState(null),[Z,ee]=p.useState(""),I=Ee({});p.useEffect(()=>{(async()=>{try{const a=await fetch(`${g}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),n=await a.json();if(!a.ok)throw new Error(n.message);A(n.map(j=>j.term)),console.log(n);const v=new Date;let y=n.find(j=>{const V=new Date(j.term_open_date),ue=new Date(j.term_close_date);return v>=V&&v<=ue});y?ee(y.term):(ee(""),console.warn("ไม่พบเทอมที่กำลังเปิดทำการ")),!y&&n.length>0&&(y=[...n].sort((j,V)=>new Date(V.term_close_date)-new Date(j.term_close_date))[0]),y?G(y.term):console.warn("ไม่พบข้อมูลเทอม (สำหรับ default selection)")}catch(a){c("error",a.message),console.error("Error fetching allRequestExamInfo:",a)}})()},[]),p.useEffect(()=>{(async()=>{try{const a=await fetch(`${g}/api/checkOpenKQ`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({type:"คำร้องขอทดสอบความรู้ทางภาษาอังกฤษ"})}),n=await a.json();if(Y(n.status),!a.ok)throw new Error(n.message)}catch(a){console.error("Error fetching checkOpenKQ:",a),c("error",a.message||"ไม่สามารถตรวจสอบสถานะการเปิดระบบได้"),Y(!1)}})()},[]),p.useEffect(()=>{if(!x||f!=null&&l==="student")return;console.log(x),(async()=>{try{const a=await fetch(`${g}/api/allRequestEngTest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({term:x})}),n=await a.json();if(!a.ok)throw new Error(n.message);b(n),console.log(n)}catch(a){c("error",a.message),console.error("Error fetching allRequestEngTest:",a)}})()},[x]),p.useEffect(()=>{if(f===null||l!=="student"||m===null)return;console.log("student"),(async()=>{try{if(m===!1)throw new Error("ระบบคำร้องขอทดสอบความรู้ทางภาษาอังกฤษยังไม่เปิด");const a=f.filter(n=>n.exam_results==="ไม่ผ่าน"||n.exam_results==="ขาดสอบ").length;if(!f.length)console.log("ลำดับ : 1 ไม่มีคำร้อง (เปิด)"),o(!1);else{if(a>2)throw console.log("ลำดับ : 2 ไม่ผ่านเกิน 3 ครั้ง (ปิด)"),o(!0),new Error("สอบไม่ผ่านเกิน 3 ครั้ง");x===f[0].term?(console.log("ลำดับ : 3 เทอมนี้ลงแล้ว (ปิด)"),o(!0)):f[0].exam_results==="ไม่ผ่าน"||f[0].exam_results==="ขาดสอบ"?(console.log("ลำดับ : 4 รอบที่แล้วไม่ผ่าน (เปิด)"),o(!1)):(console.log("ลำดับ : 5 (ปิด)"),o(!0))}}catch(a){c("error",a.message),console.error(a)}})()},[f,m,x]);const le=async()=>{try{const s=await fetch(`${g}/api/studentInfo`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),a=await s.json();if(!s.ok)throw new Error(a.message);I.setValues(a),w(!0)}catch(s){c("error",s.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching studentInfo:",s)}},pe=async()=>{try{const s=await fetch(`${g}/api/addRequestEngTest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(I.values)}),a=await s.json();if(!s.ok)throw new Error(a.message);c("success",a.message||"สำเร็จ"),w(!1),o(!0),b(n=>[...n,{...I.values,...a.data}])}catch(s){c("error",s.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching addRequestEngTest:",s)}},ce=async s=>{if(R==="noapprove"&&O.trim()===""){W("กรุณาระบุเหตุผล");return}try{const a=await fetch(`${g}/api/approveRequestEngTest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({request_eng_test_id:s.request_eng_test_id,name:T,role:l,selected:R,comment:O})}),n=await a.json();if(!a.ok)throw new Error(n.message);c("success",n.message||"สำเร็จ"),B("approve"),P(""),q(!1),b(v=>v.map(y=>y.request_eng_test_id===s.request_eng_test_id?{...y,...n.data}:y))}catch(a){c("error",a.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching approveRequestExam:",a)}},ie=async s=>{try{const a=await fetch(`${g}/api/payRequestEngTest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({request_eng_test_id:s.request_eng_test_id,receipt_vol:"154",receipt_No:"4",receipt_pay:"1000"})}),n=await a.json();if(!a.ok)throw new Error(n.message);c("success",n.message||"สำเร็จ"),E(!1),b(v=>v.map(y=>y.request_eng_test_id===s.request_eng_test_id?{...y,...n.data}:y))}catch(a){c("error",a.message||"เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ"),console.error("Error fetching payRequestEngTest:",a)}};function xe(s,a){return a==="student"?s:s.sort((n,v)=>Number(n.status)-Number(v.status))}const he=xe(f||[],l)?.filter(s=>{const a=[s.student_name,s.student_id].join(" ").toLowerCase().includes(z.toLowerCase()),n=x?s.term===x:!0;return a&&n})?.map(s=>r.jsxs(u.Tr,{children:[r.jsx(u.Td,{children:s.student_name}),r.jsx(u.Td,{children:s.term}),r.jsx(u.Td,{children:"ขอทดสอบความรู้ทางภาษาอังกฤษ"}),r.jsxs(u.Td,{style:{textAlign:"center"},children:[s.status<5&&s.status>0&&r.jsx(oe,{active:s.status-1,iconSize:20,styles:{separator:{marginLeft:-4,marginRight:-4},stepIcon:{fontSize:10}},children:[...Array(4)].map((a,n)=>r.jsx(oe.Step,{children:r.jsx(L,{children:s.status_text})},n))}),s.status==0&&r.jsx(L,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:s.status_text}),s.status==5&&r.jsx(L,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:s.status_text}),s.status==6&&r.jsxs(r.Fragment,{children:[r.jsx(L,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:s.status_text}),r.jsx("br",{}),!s.advisor_approvals&&"อาจารย์ที่ปรึกษา",s.advisor_approvals&&!s.chairpersons_approvals&&"ประธานหลักสูตร",s.advisor_approvals&&s.chairpersons_approvals&&!s.registrar_approvals&&"เจ้าหน้าที่ทะเบียน"]}),s.status>6&&r.jsx(te,{children:s.status_text})]}),r.jsx(u.Td,{style:{maxWidth:"150px"},children:r.jsxs(re,{children:[l==="student"&&r.jsxs(r.Fragment,{children:[s.status==="4"&&r.jsx(S,{size:"xs",color:"green",onClick:()=>{D(s),E(!0)},disabled:!m||s.term!==Z,children:"ชำระค่าธรรมเนียม"}),s.status==="5"&&r.jsx(r.Fragment,{children:r.jsx(S,{size:"xs",color:"green",children:"พิมพ์ใบเสร็จ"})})]}),r.jsx(Ae,{data:s,showType:s.status==0?void 0:l==="advisor"&&s.status<=1||l==="chairpersons"&&s.status<=2||l==="officer_registrar"&&s.status<=3?"view":void 0}),(l==="advisor"&&s.status==="1"||l==="chairpersons"&&s.status==="2"||l==="officer_registrar"&&s.status==="3")&&r.jsx(S,{size:"xs",color:"green",onClick:()=>{D(s),K("add"),q(!0)},disabled:!m||s.term!==Z,children:l==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"})]})})]},s.request_eng_test_id));return r.jsxs(X,{children:[r.jsx(ge,{opened:h.open,onClose:M,message:h.message,type:h.type}),r.jsx(de,{opened:C,onClose:()=>q(!1),selectedRow:k,selected:R,setSelected:B,comment:O,setComment:P,error:U,openApproveState:J,handleApprove:ce,role:l,title:"ลงความเห็นคำร้องขอทดสอบความรู้ทางภาษาอังกฤษ"}),r.jsx(me,{opened:$,onClose:()=>w(!1),form:I.values,handleAdd:pe,title:"เพิ่มคำร้องขอทดสอบความรู้ทางภาษาอังกฤษ"}),r.jsx(ve,{opened:Q,onClose:()=>E(!1),selectedRow:k,handlePay:ie}),r.jsx(te,{size:"1.5rem",fw:900,mb:"md",children:"คำร้องขอทดสอบความรู้ทางภาษาอังกฤษ"}),r.jsxs(re,{justify:"space-between",children:[r.jsx(X,{children:r.jsxs(Re,{align:"flex-end",gap:"sm",children:[l!=="student"&&r.jsx(ye,{placeholder:"ค้นหาชื่่อ รหัส",value:z,onChange:s=>H(s.target.value)}),r.jsx(_e,{placeholder:"เทอมการศึกษา",data:i,value:x,onChange:G,allowDeselect:!1})]})}),r.jsx(X,{children:l==="student"&&r.jsx(S,{onClick:()=>le(),disabled:m===!1||t,children:"เพิ่มคำร้อง"})})]}),r.jsx(Oe,{h:"md"}),r.jsx(fe,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:r.jsxs(u,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[r.jsx(u.Thead,{children:r.jsxs(u.Tr,{children:[r.jsx(u.Th,{style:{minWidth:100},children:"ชื่อ"}),r.jsx(u.Th,{style:{minWidth:100},children:"ภาคเรียน"}),r.jsx(u.Th,{style:{minWidth:100},children:"เรื่อง"}),r.jsx(u.Th,{style:{minWidth:110},children:"สถานะ"}),r.jsx(u.Th,{children:"การดำเนินการ"})]})}),r.jsx(u.Tbody,{children:he})]})})]})};export{Ye as default};
