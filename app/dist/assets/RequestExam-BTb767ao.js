import{w as Oe,f as de,u as pe,j as s,B as E,a as ke,c as De,x as Pe,y as $e,e as Ie,M as Ne,T as A,t as o,z as ze,A as l,v as Le,D as le,E as Be}from"./index-B7_hvkM2.js";import{M as Me}from"./ModalAdd-CclXvU2L.js";import{M as Je}from"./ModalApprove-GxzTwETF.js";import{M as Fe}from"./ModalPay-B7m0CAUf.js";import{M as Ke}from"./ModalInform-NNINQB9X.js";import{T as Qe}from"./ThemeIcon-BHeF_UDc.js";import{T as Ge}from"./Title-DlcERhJ2.js";import{P as Ue}from"./Pdfg01-C0u_maH6.js";import{j as We}from"./index-VWaDGczM.js";import{u as He}from"./use-form-DDBi_7fX.js";import{S as ie}from"./Stepper-B-uTcAaD.js";import{P as F}from"./Pill-B7ktLfj6.js";import{G as ue}from"./Group-dxvsYpX2.js";import{B as K}from"./Button-fInQYk36.js";import{F as Ve}from"./Flex-CXnzITNo.js";import{S as Xe}from"./Space-CyCyKMgB.js";import"./Checkbox-BOck0Pse.js";import"./Image-QhnbGiva.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./PdfUtils-2D7kTCyc.js";import"./dayjs.min-TNDP4t9g.js";const[Ye,Ze]=Oe("List component was not found in tree");var V={root:"m_abbac491",item:"m_abb6bec2",itemWrapper:"m_75cd9f71",itemIcon:"m_60f83e5b"};const X=de((c,p)=>{const a=pe("ListItem",null,c),{classNames:y,className:j,style:m,styles:C,vars:i,icon:O,children:k,mod:T,...D}=a,h=Ze(),q=O||h.icon,_={classNames:y,styles:C};return s.jsx(E,{...h.getStyles("item",{..._,className:j,style:m}),component:"li",mod:[{"with-icon":!!q,centered:h.center},T],ref:p,...D,children:s.jsxs("div",{...h.getStyles("itemWrapper",_),children:[q&&s.jsx("span",{...h.getStyles("itemIcon",_),children:q}),s.jsx("span",{...h.getStyles("itemLabel",_),children:k})]})})});X.classes=V;X.displayName="@mantine/core/ListItem";const es={type:"unordered"},ss=De((c,{size:p,spacing:a})=>({root:{"--list-fz":Ie(p),"--list-lh":$e(p),"--list-spacing":Pe(a)}})),z=de((c,p)=>{const a=pe("List",es,c),{classNames:y,className:j,style:m,styles:C,unstyled:i,vars:O,children:k,type:T,withPadding:D,icon:h,spacing:q,center:_,listStyleType:Q,mod:P,attributes:G,...L}=a,$=ke({name:"List",classes:V,props:a,className:j,style:m,classNames:y,styles:C,unstyled:i,attributes:G,vars:O,varsResolver:ss});return s.jsx(Ye,{value:{center:_,icon:h,getStyles:$},children:s.jsx(E,{...$("root",{style:{listStyleType:Q}}),component:T==="unordered"?"ul":"ol",mod:[{"with-padding":D},P],ref:p,...L,children:k})})});z.classes=V;z.displayName="@mantine/core/List";z.Item=X;const ts=({opened:c,onClose:p,missingCoures:a,type:y})=>s.jsx(Ne,{opened:c,onClose:p,title:s.jsx(E,{className:"flex items-center gap-2",children:s.jsx(Ge,{order:4,c:"red",children:"ลงทะเบียนเรียนไม่ครบตามหลักสูตร"})}),centered:!0,children:s.jsxs(E,{children:[s.jsxs(A,{mb:"sm",c:"dimmed",children:["คุณยังขาดการลงทะเบียนในรายวิชาต่อไปนี้ จึงจะสามารถยื่นคำร้องขอสอบ",y]}),s.jsx(z,{spacing:"sm",icon:s.jsx(Qe,{color:"blue",size:20,radius:"xl",children:"•"}),children:a.map((j,m)=>s.jsx(z.Item,{children:s.jsxs(A,{fw:500,children:[j.course_id," ",j.course_name]})},m))})]})}),x="http://localhost:8080",Rs=()=>{const c=localStorage.getItem("token"),p=o.useMemo(()=>We(c),[c]),a=p.role,y=p.user_id,j=p.name,[m,C]=o.useState({open:!1,type:"",message:"",timeout:3e3}),i=(e,t,r=3e3)=>C({open:!0,type:e,message:t,timeout:r}),O=()=>C(e=>({...e,open:!1})),[k,T]=o.useState(!1),[D,h]=o.useState(!1),[q,_]=o.useState(!1),[Q,P]=o.useState(!1),[G,L]=o.useState(!1),[$,Y]=o.useState(null),[U,Z]=o.useState("approve"),[W,ee]=o.useState(""),[he,me]=o.useState(""),[S,fe]=o.useState(""),[f,B]=o.useState(null),[se,ge]=o.useState(""),[H,te]=o.useState(""),[xe,I]=o.useState(!0),[ye,je]=o.useState([]),M=He({}),[re,oe]=o.useState(""),[b,ae]=o.useState(null),{type:J}=ze();o.useEffect(()=>{te(J)},[J]);const[_e,Se]=o.useState([]),[g,ne]=o.useState(""),[rs,os]=o.useState(null);o.useEffect(()=>{(async()=>{try{const r=await fetch(`${x}/api/profile`,{method:"GET",headers:{Authorization:`Bearer ${c}`}}),n=await r.json();if(!r.ok)throw new Error(n.message);fe(n),console.log(n)}catch(r){i("error",r.message),console.error(r)}})(),(async()=>{try{const r=await fetch(`${x}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}}),n=await r.json();if(!r.ok)throw new Error(n.message);Se(n.map(w=>w.term)),console.log(n);const u=new Date;let d=n.find(w=>{const v=new Date(w.term_open_date),R=new Date(w.term_close_date);return u>=v&&u<=R});d?(oe(d.term),console.log(d.term)):oe(""),!d&&n.length>0&&(d=[...n].sort((w,v)=>new Date(v.term_close_date)-new Date(w.term_close_date))[0]),d?ne(d.term):console.warn("ไม่พบข้อมูลเทอม")}catch(r){i("error",r.message),console.error("Error fetching allRequestExamInfo:",r)}})()},[]),o.useEffect(()=>{(async()=>{try{const t=await fetch(`${x}/api/checkOpenKQ`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({type:"คำร้องขอสอบประมวลความรู้/วัดคุณสมบัติ"})}),r=await t.json();if(ae(r.status),!t.ok&&t.status!==403)throw new Error(r.message)}catch(t){console.error("Error fetching checkOpenKQ:",t),ae(!1)}})()},[]),o.useEffect(()=>{if(!g||f!=null&&a==="student")return;console.log(g),(async()=>{try{const t=await fetch(`${x}/api/requestExamAll`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({term:g})}),r=await t.json();if(!t.ok)throw new Error(r.message);B(r),console.log("all request :",r)}catch(t){i("error",t.message),console.error("Error fetching requestExamAll:",t)}})()},[g]),o.useEffect(()=>{if(f===null||a!=="student"||b===null)return;console.log("student"),(async()=>{try{if(b===!1)throw new Error("ระบบคำร้องขอสอบประมวลความรู้/วัดคุณสมบัติยังไม่เปิด");if(y==="674140101"){const r=await fetch(`${x}/api/allStudyGroupIdCourseRegistration`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}}),n=await r.json();if(!r.ok)throw new Error(n.message);console.log("ที่ต้องลง :",n);const u=await fetch("https://mua.kpru.ac.th/FrontEnd_Tabian/apiforall/ListSubjectPass",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ID_NO:y})}),d=await u.json();if(!u.ok)throw new Error(d.message);console.log("ที่ลง :",d);const w=d.map(R=>R.SJCODE),v=n.course_id.filter(R=>!w.includes(R));if(console.log("ที่ขาด :",v),v.length>0){const Re=await(await fetch("https://mua.kpru.ac.th/FrontEnd_Tabian/apiforall/ListSubjectAll")).json(),Ae=new Map(Re.map(N=>[N.SUBJCODE,N.SUBJNAME])),ce=v.map(N=>({course_id:N,course_name:Ae.get(N)||"ไม่พบข้อมูล"}));console.log("รายวิชาที่ขาด :",ce),je(ce),L(!0);return}}const t=f.filter(r=>r.exam_results==="ไม่ผ่าน"||r.exam_results==="ขาดสอบ").length;if(!f.length)console.log("ลำดับ : 1 ไม่มีคำร้อง (เปิด)"),I(!1);else{if(t>2)throw console.log("ลำดับ : 2 ไม่ผ่านเกิน 3 ครั้ง (ปิด)"),I(!0),new Error("สอบไม่ผ่านเกิน 3 ครั้ง");g===f[0].term?(console.log("ลำดับ : 3 เทอมนี้ลงแล้ว (ปิด)"),I(!0)):f[0].exam_results==="ไม่ผ่าน"||f[0].exam_results==="ขาดสอบ"?(console.log("ลำดับ : 4 รอบที่แล้วไม่ผ่าน (เปิด)"),I(!1)):(console.log("ลำดับ : 5 (ปิด)"),I(!0))}}catch(t){i("error",t.message,1e4),console.error(t)}})()},[f,b,g]);const we=async()=>{try{const e=await fetch(`${x}/api/studentInfo`,{method:"GET",headers:{Authorization:`Bearer ${c}`}}),t=await e.json();if(!e.ok)throw new Error(t.message);M.setValues({...t,term:g}),T(!0)}catch(e){i("error",e.message),console.error("Error fetching studentInfo:",e)}},Te=async()=>{try{const e=await fetch(`${x}/api/addRequestExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(M.values)}),t=await e.json();if(console.log(e),console.log(t),!e.ok)throw new Error(t.message);i("success",t.message),T(!1),B(r=>[...r,{...t.data,...M.values}])}catch(e){i("error",e.message),console.error("Error fetching addRequestExam:",e)}},ve=async e=>{if(U==="noapprove"&&W.trim()===""){me("กรุณาระบุเหตุผล");return}try{const t=await fetch(`${x}/api/approveRequestExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({request_exam_id:e.request_exam_id,name:j,selected:U,comment:W})}),r=await t.json();if(!t.ok)throw new Error(r.message);i("success",r.message||"สำเร็จ"),Z("approve"),ee(""),h(!1),B(n=>n.map(u=>u.request_exam_id===e.request_exam_id?{...u,...r.data}:u))}catch(t){i("error",t.message),console.error("Error fetching approveRequestExam:",t)}},Ee=async e=>{try{const t=await fetch(`${x}/api/payRequestExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({request_exam_id:e.request_exam_id,receipt_vol:"2564",receipt_No:"1",receipt_pay:"1000"})}),r=await t.json();if(!t.ok)throw new Error(r.message);i("success",r.message||"สำเร็จ"),P(!1),console.log("ข้อมูลตอบกลับ ",r),B(n=>n.map(u=>u.request_exam_id===e.request_exam_id?{...u,...r.data}:u))}catch(t){i("error",t.message),console.error("Error fetching payRequestExam:",t)}},Ce=async e=>{console.log("test");try{const t=await fetch(`${x}/api/printReceipt`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({...e,amount:S.education_level==="ปริญญาโท"?1e3:1500})}),r=await t.json();if(!t.ok)throw new Error(r.message);i("success",r.message||"สำเร็จ"),console.log("ข้อมูลตอบกลับ ",r)}catch(t){i("error",t.message),console.error("Error fetching payRequestExam:",t)}};function qe(e,t){return t==="student"?e:[...e].sort((r,n)=>{const u=Number(r.status)===0?1:0,d=Number(n.status)===0?1:0;return u-d||Number(r.status)-Number(n.status)})}const be=qe(f??[],a).filter(e=>{const t=[e.student_name,e.student_id].join(" ").toLowerCase().includes(se.toLowerCase()),r=H?e.request_type===H:!0,n=g?e.term===g:!0;return t&&r&&n}).map(e=>s.jsxs(l.Tr,{children:[s.jsx(l.Td,{children:e.student_name}),s.jsx(l.Td,{style:{textAlign:"center"},children:e.term}),s.jsx(l.Td,{children:e.request_type}),s.jsxs(l.Td,{style:{textAlign:"center"},children:[e.status<=4&&e.status>0&&s.jsx(ie,{active:e.status-1,iconSize:20,styles:{separator:{marginLeft:-4,marginRight:-4},stepIcon:{fontSize:10}},children:[...Array(4)].map((t,r)=>s.jsx(ie.Step,{children:s.jsx(F,{children:e.status_text})},r))}),(e.status==0||e.status>6)&&s.jsx(F,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),e.status==5&&s.jsx(F,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:e.status_text}),e.status==6&&s.jsxs(s.Fragment,{children:[s.jsx(F,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),s.jsx("br",{}),!e.advisor_approvals&&"อาจารย์ที่ปรึกษา",e.advisor_approvals&&!e.chairpersons_approvals&&"ประธานกรรมการปะจำสาขาวิชา",e.advisor_approvals&&e.chairpersons_approvals&&!e.registrar_approvals&&"เจ้าหน้าที่ทะเบียน"]})]}),s.jsx(l.Td,{style:{maxWidth:"150px"},children:s.jsxs(ue,{children:[a==="student"&&s.jsxs(s.Fragment,{children:[e.status==="4"&&s.jsx(K,{size:"xs",color:"green",onClick:()=>{Y(e),P(!0)},disabled:!b||e.term!==re,children:"ชำระค่าธรรมเนียม"}),e.receipt_vol!=null&&s.jsx(K,{size:"xs",color:"green",onClick:()=>{Ce(e),console.log("asd")},children:"พิมพ์ใบเสร็จ"})]}),s.jsx(Ue,{data:e,showType:e.status==0?void 0:a==="advisor"&&e.status<=1||a==="chairpersons"&&e.status<=2||a==="officer_registrar"&&e.status<=3?"view":void 0}),(a==="advisor"&&e.status==1||a==="chairpersons"&&e.status==2||a==="officer_registrar"&&e.status==3)&&s.jsx(K,{size:"xs",color:"green",onClick:()=>{Y(e),_("add"),h(!0)},disabled:!b||e.term!==re,children:a==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"})]})}),e.exam_results!==null&&s.jsxs(l.Td,{style:{textAlign:"center"},children:[e.exam_results==="ผ่าน"&&s.jsx(A,{c:"green",children:"ผ่าน"}),e.exam_results==="ไม่ผ่าน"&&s.jsx(A,{c:"red",children:"ไม่ผ่าน"}),e.exam_results==="ขาดสอบ"&&s.jsx(A,{c:"gray",children:"ขาดสอบ"})]})]},e.request_exam_id));return s.jsxs(E,{children:[s.jsx(ts,{opened:G,onClose:()=>L(!1),missingCoures:ye,type:S.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}),s.jsx(Ke,{opened:m.open,onClose:O,message:m.message,type:m.type,timeout:m.timeout}),s.jsx(Je,{opened:D,onClose:()=>h(!1),selectedRow:$,selected:U,setSelected:Z,comment:W,setComment:ee,error:he,openApproveState:q,handleApprove:ve,role:a,title:`${a==="officer_registrar"?"ตรวจสอบ":"ลงความเห็น"}คำร้องขอสอบ${S.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`}),s.jsx(Me,{opened:k,onClose:()=>T(!1),form:M.values,handleAdd:Te,title:`เพิ่มคำร้องขอสอบ${S.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`}),s.jsx(Fe,{opened:Q,onClose:()=>P(!1),selectedRow:$,handlePay:Ee,MoneyRegis:S.education_level==="ปริญญาโท"?1e3:1500,type:`คำร้องขอสอบ${S.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`,stop_date:"15/11/2568"}),s.jsx(A,{size:"1.5rem",fw:900,mb:"md",children:`คำร้องขอสอบ${J||`${S.education_level?`${S.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`:"ประมวลความรู้/วัดคุณสมบัติ"}`}`}),s.jsxs(ue,{justify:"space-between",children:[s.jsx(E,{children:s.jsxs(Ve,{align:"flex-end",gap:"sm",children:[a!=="student"&&s.jsx(Le,{placeholder:"ค้นหา ชื่่อ รหัส",value:se,onChange:e=>ge(e.target.value)}),!["student","officer_registrar"].includes(a)&&s.jsx(le,{placeholder:"ชนิดคำขอ",data:["ขอสอบประมวลความรู้","ขอสอบวัดคุณสมบัติ"],value:H,onChange:te}),s.jsx(le,{placeholder:"เทอมการศึกษา",data:_e,value:g,onChange:ne,allowDeselect:!1})]})}),s.jsx(E,{children:a==="student"&&s.jsx(K,{onClick:()=>we(),disabled:b===!1||xe,children:"เพิ่มคำร้อง"})})]}),s.jsx(Xe,{h:"md"}),s.jsx(Be,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:s.jsxs(l,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[s.jsx(l.Thead,{children:s.jsxs(l.Tr,{children:[s.jsx(l.Th,{children:"ชื่อ"}),s.jsx(l.Th,{children:"ภาคเรียน"}),s.jsx(l.Th,{children:"เรื่อง"}),s.jsx(l.Th,{children:"สถานะ"}),s.jsx(l.Th,{children:"การดำเนินการ"}),f?.some(e=>e.exam_results!==null)&&s.jsx(l.Th,{children:"ผลสอบ"})]})}),s.jsx(l.Tbody,{children:be})]})})]})};export{Rs as default};
