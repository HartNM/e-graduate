import{t as a,j as t,A as c,B as E,T as re,v as ae,D as ne,E as ce}from"./index-B7_hvkM2.js";import{P as le,M as ie}from"./Pdfg08-BjFpCyxm.js";import{M as de}from"./ModalApprove-GxzTwETF.js";import{M as pe}from"./ModalInform-NNINQB9X.js";import{j as ue}from"./index-VWaDGczM.js";import{u as he}from"./use-form-DDBi_7fX.js";import{P as q}from"./Pill-B7ktLfj6.js";import{G as D}from"./Group-dxvsYpX2.js";import{B as b}from"./Button-fInQYk36.js";import{F as me}from"./Flex-CXnzITNo.js";import{S as fe}from"./Space-CyCyKMgB.js";import"./Textarea-Dei6KChT.js";import"./DatePickerInput-DIAi7llo.js";import"./dayjs.min-TNDP4t9g.js";import"./use-disclosure-f2FIm-Gp.js";import"./PdfUtils-2D7kTCyc.js";import"./Checkbox-BOck0Pse.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";const h="http://localhost:8080",ze=()=>{const i=localStorage.getItem("token"),g=ue(i),l=g.role;g.user_id,console.log("token :",g);const[_,v]=a.useState({open:!1,type:"",message:""}),d=(e,r)=>v({open:!0,type:e,message:r}),$=()=>v(e=>({...e,open:!1})),[k,j]=a.useState(!1),[B,w]=a.useState(!1),[O,z]=a.useState(!1),[I,N]=a.useState(null),[y,A]=a.useState("approve"),[S,R]=a.useState(""),[L,M]=a.useState(""),[F,G]=a.useState(""),[J,T]=a.useState([]),[P,H]=a.useState(""),f=he({initialValues:{student_name:"",student_id:"",education_level:"",program:"",major_name:"",faculty_name:"",reason:"",thesis_exam_date:""},validate:{reason:e=>e.trim()===""?"กรุณากรอกเหตุผล":null,thesis_exam_date:e=>{if(!e)return"กรุณาระบุวันที่สอบ"}}}),[U,V]=a.useState([]),[W,C]=a.useState("");a.useEffect(()=>{(async()=>{try{const s=await fetch(`${h}/api/profile`,{method:"GET",headers:{Authorization:`Bearer ${i}`}}),o=await s.json();if(!s.ok)throw new Error(o.message);G(o)}catch(s){d("error",s.message),console.error("Error fetching profile:",s)}})(),(async()=>{try{const s=await fetch(`${h}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),o=await s.json();if(!s.ok)throw new Error(o.message);V(o.map(u=>u.term)),console.log(o);const n=new Date;let p=o.find(u=>{const m=new Date(u.term_open_date),oe=new Date(u.term_close_date);return n>=m&&n<=oe});!p&&o.length>0&&(p=[...o].sort((u,m)=>new Date(m.term_close_date)-new Date(u.term_close_date))[0]),C(p.term)}catch(s){d("error",s.message),console.error("Error fetching allRequestExamInfo:",s)}})()},[]);const[K,Q]=a.useState(!0),[X,x]=a.useState(!0);a.useEffect(()=>{l==="student"&&(async()=>{try{const s=await fetch(`${h}/api/allRequestThesisProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({lastRequest:!0})}),o=await s.json();if(!s.ok)throw new Error(o.message);Q(o[0]),console.log(o);const n=await fetch(`${h}/api/AllPlagiarismProposal`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),p=await n.json();if(!n.ok)throw new Error(p.message);console.log(p[0]),o[0]?.status==="5"&&o[0]?.exam_results===null&&new Date().setHours(0,0,0,0)<new Date(new Date(o[0]?.thesis_exam_date).getTime()-6048e5)?p[0]?x(!0):x(!1):x(!0)}catch(s){d("error",s.message),console.error("Error fetching allRequestThesisProposal:",s)}})(),(async()=>{try{const s=await fetch(`${h}/api/allPostponeProposalExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),o=await s.json();if(!s.ok)throw new Error(o.message);console.log(o),T(o)}catch(s){d("error",s.message),console.error("Error fetching AllRequestExamCancel:",s)}})()},[]);const Y=async()=>{try{const e=await fetch(`${h}/api/studentInfo`,{method:"GET",headers:{Authorization:`Bearer ${i}`}}),r=await e.json();if(!e.ok)throw new Error(r.message);f.reset(),f.setValues({...K,...r}),j(!0)}catch(e){d("error",e.message),console.error("Error fetching studentInfo:",e)}},Z=async()=>{try{const e=await fetch(`${h}/api/addPostponeProposalExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(f.values)}),r=await e.json();if(!e.ok)throw new Error(r.message);T(s=>[...s,{...f.values,...r.data}]),d("success",r.message||"สำเร็จ"),x(!0),j(!1)}catch(e){d("error",e.message),console.error("Error fetching cancelRequestExam:",e)}},ee=async e=>{if(y==="noapprove"&&S.trim()===""){M("กรุณาระบุเหตุผล");return}try{const r=await fetch(`${h}/api/approvePostponeProposalExam`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({postpone_proposal_exam_id:e.postpone_proposal_exam_id,request_thesis_proposal_id:e.request_thesis_proposal_id,thesis_exam_date:e.thesis_exam_date,name:F.name,selected:y,comment:S})}),s=await r.json();if(!r.ok)throw new Error(s.message);d("success",s.message||"สำเร็จ"),A("approve"),R(""),w(!1),T(o=>o.map(n=>n.postpone_proposal_exam_id===e.postpone_proposal_exam_id?{...n,...s.data}:n))}catch(r){d("error",r.message),console.error("Error fetching cancelApproveRequestExam:",r)}};function te(e,r){return r==="student"?e:e.sort((s,o)=>{const n=m=>Number(m)===0?2:Number(m)===5?1:0,p=n(s.status),u=n(o.status);return p-u||Number(s.status)-Number(o.status)})}const se=te(J,l).filter(e=>[e.student_name,e.student_id].join(" ").toLowerCase().includes(P.toLowerCase())).map(e=>t.jsxs(c.Tr,{children:[t.jsx(c.Td,{children:e.student_name}),t.jsxs(c.Td,{style:{textAlign:"center"},children:[e.status==5&&t.jsx(q,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:e.status_text}),e.status==6&&t.jsxs(t.Fragment,{children:[t.jsx(q,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:e.status_text}),t.jsx("br",{}),!e.advisor_approvals&&"อาจารย์ที่ปรึกษา",e.advisor_approvals&&!e.chairpersons_approvals&&"ประธานหลักสูตร"]}),e.status>6&&t.jsx(q,{children:e.status_text})]}),t.jsx(c.Td,{style:{maxWidth:"150px"},children:t.jsxs(D,{children:[t.jsx(le,{data:e,showType:e.status==5||e.status==6?void 0:l==="advisor"&&e.status==7||l==="chairpersons"&&e.status==8?"view":void 0}),(l==="research_advisor"&&e.status==="7"||l==="chairpersons"&&e.status==="8")&&t.jsx(b,{size:"xs",color:"green",onClick:()=>{N(e),z("cancel"),w(!0)},children:"ลงความเห็น"})]})})]},e.postpone_proposal_exam_id));return t.jsxs(E,{children:[t.jsx(ie,{opened:k,onClose:()=>j(!1),form:f,handleAdd:Z,title:"เพิ่มคำร้องขอสอบโครงร่างวิทยานิพนธ์/การค้นคว้าอิสระ"}),t.jsx(pe,{opened:_.open,onClose:$,message:_.message,type:_.type}),t.jsx(de,{opened:B,onClose:()=>w(!1),selectedRow:I,selected:y,setSelected:A,comment:S,setComment:R,error:L,openApproveState:O,handleCancel:ee,role:l,title:"ลงความเห็นคำร้องขอเลื่อนสอบโครงร่างวิทยานิพนธ์/การค้นคว้าอิสระ"}),t.jsx(re,{size:"1.5rem",fw:900,mb:"md",children:"คำร้องขอเลื่อนสอบโครงร่างวิทยานิพนธ์/การค้นคว้าอิสระ"}),t.jsxs(D,{justify:"space-between",children:[t.jsx(E,{children:t.jsxs(me,{align:"flex-end",gap:"sm",children:[l!=="student"&&t.jsx(ae,{placeholder:"ค้นหาชื่่อ รหัส",value:P,onChange:e=>H(e.target.value)}),l!=="student"&&t.jsx(ne,{placeholder:"เทอมการศึกษา",data:U,value:W,onChange:C,allowDeselect:!1})]})}),t.jsx(E,{children:l==="student"&&t.jsx(t.Fragment,{children:t.jsx(b,{onClick:()=>Y(),disabled:X,children:"เพิ่มคำร้อง"})})})]}),t.jsx(fe,{h:"md"}),t.jsx(ce,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:t.jsxs(c,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[t.jsx(c.Thead,{children:t.jsxs(c.Tr,{children:[t.jsx(c.Th,{children:"ชื่อ"}),t.jsx(c.Th,{children:"สถานะ"}),t.jsx(c.Th,{children:"การดำเนินการ"})]})}),t.jsx(c.Tbody,{children:se})]})})]})};export{ze as default};
