import{j as o,M as ue,B as N,v as j,t as p,A as x,T as he,D as Y,E as ye}from"./index-B7_hvkM2.js";import{T as _e}from"./Textarea-Dei6KChT.js";import{F as se}from"./Flex-CXnzITNo.js";import{B as O}from"./Button-fInQYk36.js";import{M as fe}from"./ModalApprove-GxzTwETF.js";import{M as me}from"./ModalInform-NNINQB9X.js";import{P as ve,f as we,s as je,a as ge,b as W,d as be,c as Se,e as G}from"./PdfUtils-2D7kTCyc.js";import{j as qe}from"./index-VWaDGczM.js";import{P as H}from"./Pill-B7ktLfj6.js";import{S as Z}from"./Stepper-B-uTcAaD.js";import{G as ee}from"./Group-dxvsYpX2.js";import{S as Te}from"./Space-CyCyKMgB.js";import"./Checkbox-BOck0Pse.js";/* empty css                    */import"./createReactComponent-DJN_V7q0.js";import"./dayjs.min-TNDP4t9g.js";const Re=e=>o.jsx(ue,{opened:e.opened,onClose:e.onClose,title:`คำร้องขอยกเลิกสอบ${e.selectedRow?.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`,centered:!0,children:e.selectedRow&&o.jsxs(N,{children:[o.jsx(j,{label:"ชื่อ",disabled:!0,value:e.selectedRow.student_name}),o.jsx(j,{label:"รหัสประจำตัว",disabled:!0,value:e.selectedRow.student_id}),o.jsx(j,{label:"ระดับ",disabled:!0,value:e.selectedRow.education_level}),o.jsx(j,{label:"หลักสูตร",disabled:!0,value:e.selectedRow.program}),o.jsx(j,{label:"สาขา",disabled:!0,value:e.selectedRow.major_name}),o.jsx(j,{label:"คณะ",disabled:!0,value:e.selectedRow.faculty_name}),o.jsx(_e,{label:"เนื่องจาก",required:!0,autosize:!0,minRows:2,value:e.reason,onChange:h=>e.setReason(h.currentTarget.value),error:e.error}),o.jsx(se,{justify:"flex-end",children:o.jsx(O,{color:"green",onClick:()=>e.handleAddCancel(e.selectedRow),children:"บันทึก"})})]})}),Ce="http://localhost:8080";async function te(e){const h=await ve.create();h.registerFontkit(we);const l=h.addPage([595,842]);await je(h);const T=await fetch("/fonts/THSarabunNew Bold.ttf").then(d=>d.arrayBuffer()),u=await h.embedFont(T),_=localStorage.getItem("token"),i={advisor:"advisor_approvals_id",chairpersons:"chairpersons_approvals_id",registrar:"dean_approvals_id"};try{for(const[d,v]of Object.entries(i)){const $=e?.[v];if(!$||isNaN(Number($)))continue;const b=await(await fetch(`${Ce}/api/personnelInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${_}`},body:JSON.stringify({user_id:$})})).json();b&&(e[v]=b.name)}}catch(d){console.error("Error fetch personnelInfo:",d)}const[D,B,g]=ge(e?.request_date),[L,F,M]=W(e?.advisor_approvals_date),[R,C,z]=W(e?.chairpersons_approvals_date),[E,P,A]=W(e?.dean_approvals_date);let t=760,r=20;be(l,`คำร้อง${e.request_type}`,780,u,20),[{text:"มหาวิทยาลัยราชภัฏกำแพงเพชร",x:420,y:t-=r},{text:"วันที่................เดือน...........................พ.ศ...................",x:350,y:t-=r},{text:D,x:380,y:t+2},{text:B,x:440,y:t+2},{text:g,x:510,y:t+2},{text:"เรื่อง",x:60,y:t-=r*2,font:u},{text:e.request_type,x:100,y:t},{text:"เรียน",x:60,y:t-=r,font:u},{text:`คณบดี${e?.faculty_name}`,x:100,y:t},{text:"ข้าพเจ้า................................................................................................รหัสประจำตัวนักศึกษา.................................................",x:100,y:t-=r*2},{text:e?.student_name,x:180,y:t+2},{text:e?.student_id,x:460,y:t+2},{text:"ระดับ...........................................หลักสูตร...............................................................................สาขาวิชา....................................................",x:60,y:t-=r},{text:e?.education_level,x:110,y:t+2},{text:e?.program,x:230,y:t+2},{text:e?.major_name,x:440,y:t+2},{text:"คณะ..........................................................................................มีความประสงค์.........................................................................................",x:60,y:t-=r},{text:e?.faculty_name,x:100,y:t+2},{text:e.request_type,x:360,y:t+2},{text:"เนื่่องจาก.....................................................................................................................................................................................................",x:60,y:t-=r},{text:e?.reason,x:140,y:t+2},{text:"จึงเรียนมาเพื่อโปรดพิจารณา",x:100,y:t-=r},{text:"ลงชื่อ...........................................................................",x:310,y:t-=r*2},{text:e?.student_name,x:370,y:t+2},{text:"(.........................................................................)",x:330,y:t-=r},{text:e?.student_name,x:370,y:t+2},{text:"นักศึกษา",x:400,y:t-=r},{text:"วันที่................/........................../......................",x:330,y:t-=r},{text:D,x:360,y:t+2},{text:B,x:400,y:t+2},{text:g,x:465,y:t+2},{text:"1. ความเห็นของอาจารย์ที่ปรึกษาหมู่เรียน",x:60,y:t-=r*2,font:u,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals?"เห็นควรอนุญาต":"ไม่อนุญาต",x:80,y:t-=r,show:typeof e?.advisor_approvals=="boolean"},{text:`เนื่องจาก ${e?.comment}`,x:80,y:t-=r,show:typeof e?.advisor_approvals=="boolean"&&!e.advisor_approvals},{text:"ลงชื่อ.......................................................................",x:75,y:t-=r*2,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals_id,x:140,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"(.....................................................................) ",x:95,y:t-=r,show:typeof e?.advisor_approvals=="boolean"},{text:e?.advisor_approvals_id,x:140,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"อาจารย์ที่ปรึกษา",x:145,y:t-=r,show:typeof e?.advisor_approvals=="boolean"},{text:"วันที่ ........../................./...................",x:110,y:t-=r,show:typeof e?.advisor_approvals=="boolean"},{text:L,x:135,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:F,x:170,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:M,x:210,y:t+2,show:typeof e?.advisor_approvals=="boolean"},{text:"2. ความเห็นประธานกรรมการบัณฑิตศึกษาประจำสาขาวิชา",x:310,y:t+=r*7,font:u,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals?"เห็นควรอนุญาต":"ไม่อนุญาต",x:330,y:t-=r,show:typeof e?.chairpersons_approvals=="boolean"},{text:`เนื่องจาก ${e?.comment}`,x:330,y:t-=r,show:typeof e?.chairpersons_approvals=="boolean"&&!e.chairpersons_approvals},{text:"ลงชื่อ.......................................................................",x:325,y:t-=r*2,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals_id,x:390,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:"(.....................................................................) ",x:345,y:t-=r,show:typeof e?.chairpersons_approvals=="boolean"},{text:e?.chairpersons_approvals_id,x:390,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:"ประธานกรรมการบัณฑิตศึกษาประจำสาขาวิชา",x:340,y:t-=r,show:typeof e?.chairpersons_approvals=="boolean"},{text:"วันที่ ........../................./...................",x:360,y:t-=r,show:typeof e?.chairpersons_approvals=="boolean"},{text:R,x:385,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:C,x:420,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:z,x:460,y:t+2,show:typeof e?.chairpersons_approvals=="boolean"},{text:`3. ความเห็นคณบดี${e?.faculty_name}`,x:185,y:t-=r*1.5,font:u,show:e?.dean_approvals!==null},{text:e?.dean_approvals?"อนุญาต":"ไม่อนุญาต",x:205,y:t-=r,show:e?.dean_approvals!==null},{text:`เนื่องจาก ${e?.comment}`,x:250,y:t-=r,show:e?.dean_approvals!==null&&!e.dean_approvals},{text:"ลงชื่อ.......................................................................",x:200,y:t-=r*2,show:e?.dean_approvals!==null},{text:e?.dean_approvals_id,x:265,y:t+2,show:e?.dean_approvals!==null},{text:"(.....................................................................) ",x:220,y:t-=r,show:e?.dean_approvals!==null},{text:e?.dean_approvals_id,x:265,y:t+2,show:e?.dean_approvals!==null},{text:`คณบดี${e?.faculty_name}`,x:260,y:t-=r,show:e?.dean_approvals!==null},{text:"วันที่ ........../................./...................",x:235,y:t-=r,show:e?.dean_approvals!==null},{text:E,x:260,y:t+2,show:e?.dean_approvals!==null},{text:P,x:295,y:t+2,show:e?.dean_approvals!==null},{text:A,x:335,y:t+2,show:e?.dean_approvals!==null}].filter(d=>d.show!==!1).forEach(d=>Se(l,d.text,d.x,d.y,d.font,d.size)),typeof e?.advisor_approvals=="boolean"&&G(l,50,t+r*8,250,r*8.5),typeof e?.chairpersons_approvals=="boolean"&&G(l,300,t+r*8,250,r*8.5),e?.dean_approvals!==null&&G(l,50,t-r*.5,500,r*8.5);const I=await h.save();return new Blob([I],{type:"application/pdf"})}function Ee({data:e,showType:h}){const l=async()=>{const u=await te(e),_=URL.createObjectURL(u);window.open(_,"_blank")},T=async()=>{const u=await te(e),_=URL.createObjectURL(u),i=document.createElement("iframe");i.style.display="none",i.src=_,document.body.appendChild(i),i.onload=()=>{i.contentWindow.print()}};return o.jsx(o.Fragment,{children:h==="view"?o.jsx(O,{size:"xs",color:"gray",onClick:l,children:"ข้อมูล"}):o.jsx(O,{size:"xs",color:"blue",onClick:T,children:"พิมพ์"})})}const m="http://localhost:8080",Xe=()=>{const e=localStorage.getItem("token"),h=p.useMemo(()=>qe(e),[e]),l=h.role,T=h.name,[u,_]=p.useState({open:!1,type:"",message:""}),i=(s,a)=>_({open:!0,type:s,message:a}),D=()=>_(s=>({...s,open:!1})),[B,g]=p.useState(!1),[L,F]=p.useState(!1),[M,R]=p.useState(!1),[C,z]=p.useState(null),[E,P]=p.useState("approve"),[A,t]=p.useState(""),[r,X]=p.useState(""),[I,d]=p.useState(""),[v,$]=p.useState(""),[U,b]=p.useState(null),[K,oe]=p.useState(""),[J,re]=p.useState(""),[ae,ne]=p.useState([]),[w,Q]=p.useState("");p.useEffect(()=>{(async()=>{try{const n=await fetch(`${m}/api/profile`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),c=await n.json();if(!n.ok)throw new Error(c.message);console.log(c),$(c)}catch(n){i("error",n.message),console.error(n)}})(),(async()=>{try{const n=await fetch(`${m}/api/allRequestExamInfo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),c=await n.json();if(!n.ok)throw new Error(c.message);ne(c.map(f=>f.term)),console.log(c);const y=new Date;let k=c.find(f=>{const q=new Date(f.term_open_date),xe=new Date(f.term_close_date);return y>=q&&y<=xe});!k&&c.length>0&&(k=[...c].sort((f,q)=>new Date(q.term_close_date)-new Date(f.term_close_date))[0]),Q(k.term)}catch(n){i("error",n.message),console.error("Error fetching allRequestExamInfo:",n)}})()},[]),p.useEffect(()=>{if(!w||U!=null&&l==="student")return;console.log("เทอมนี้ ",w),(async()=>{try{const a=await fetch(`${m}/api/AllRequestExamCancel`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({term:w})}),n=await a.json();if(!a.ok)throw new Error(n.message);b(n),console.log("คำร้องทังหมด",n)}catch(a){i("error",a.message),console.error("Error fetching AllRequestExamCancel:",a)}})()},[w]);const[S,V]=p.useState(null);p.useEffect(()=>{l==="student"&&(async()=>{try{const a=await fetch(`${m}/api/requestExamAll`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({lastRequest:!0})}),n=await a.json();if(!a.ok)throw new Error(n.message);console.log(n[0]);const c=await fetch(`${m}/api/CheckOpenREC`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),y=await c.json();if(!c.ok)throw new Error(y.message);console.log("วันที่ :",y),V(n[0])}catch(a){i("error",a.message),console.error("Error fetching requestExamAll:",a)}})()},[]);const le=async()=>{try{const s=await fetch(`${m}/api/studentInfo`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),a=await s.json();if(!s.ok)throw new Error(a.message);z(a),R(!0),d("")}catch(s){i("error",s.message),console.error("Error fetching studentInfo:",s)}},ce=async()=>{if(!r.trim()){d("กรุณากรอกเหตุผล");return}try{const s=await fetch(`${m}/api/AddRequestExamCancel`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({reason:r,request_type:`ขอยกเลิกการเข้าสอบ${v.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`})}),a=await s.json();if(!s.ok)throw new Error(a.message);V(!0),i("success",a.message||"สำเร็จ"),R(!1),b(n=>[...n,{...C,...a.data}])}catch(s){i("error",s.message),console.error("Error fetching cancelRequestExam:",s)}},pe=async s=>{if(E==="noapprove"&&A.trim()===""){d("กรุณาระบุเหตุผล");return}try{const a=await fetch(`${m}/api/ApproveRequestExamCancel`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({request_cancel_exam_id:s.request_cancel_exam_id,request_exam_id:s.request_exam_id,name:T,role:l,selected:E,comment_cancel:A})}),n=await a.json();if(!a.ok)throw new Error(n.message);i("success",n.message||"สำเร็จ"),P("approve"),t(""),g(!1),b(c=>c.map(y=>y.request_cancel_exam_id===s.request_cancel_exam_id?{...y,...n.data}:y))}catch(a){i("error",a.message),console.error("Error fetching cancelApproveRequestExam:",a)}};function ie(s,a){return a==="student"?s:s.sort((n,c)=>{const y=q=>Number(q)===0?2:Number(q)===5?1:0,k=y(n.status),f=y(c.status);return k-f||Number(n.status)-Number(c.status)})}const de=ie(U||[],l)?.filter(s=>{const a=[s.student_name,s.student_id].join(" ").toLowerCase().includes(K.toLowerCase()),n=J?s.request_type===J:!0,c=w?s.term===w:!0;return a&&n&&c})?.map(s=>o.jsxs(x.Tr,{children:[o.jsx(x.Td,{children:s.student_name}),o.jsx(x.Td,{children:s.term}),o.jsx(x.Td,{children:l==="dean"?`ขอยกเลิก${s.request_type.replace("ขอ","")}`:s.request_type}),o.jsxs(x.Td,{style:{textAlign:"center"},children:[s.status==0&&o.jsx(H,{variant:"filled",style:{backgroundColor:"#ccffcc",color:"#006600"},children:s.status_text}),s.status==5&&o.jsxs(o.Fragment,{children:[o.jsx(H,{variant:"filled",style:{backgroundColor:"#ffcccc",color:"#b30000"},children:s.status_text}),o.jsx("br",{}),!s.advisor_approvals&&"อาจารย์ที่ปรึกษา",s.advisor_approvals&&!s.chairpersons_approvals&&"ประธานกรรมการปะจำสาขาวิชา",s.advisor_approvals&&s.chairpersons_approvals&&!s.registrar_approvals&&"เจ้าหน้าที่ทะเบียน"]}),s.status>6&&o.jsx(Z,{active:s.status-7,iconSize:20,styles:{separator:{marginLeft:-4,marginRight:-4},stepIcon:{fontSize:10}},children:[...Array(3)].map((a,n)=>o.jsx(Z.Step,{children:o.jsx(H,{children:s.status_text})},n))})]}),o.jsx(x.Td,{style:{maxWidth:"150px"},children:o.jsxs(ee,{children:[o.jsx(Ee,{data:s,showType:s.status==5||s.status==0?void 0:l==="advisor"&&s.status<=7||l==="chairpersons"&&s.status<=8||l==="dean"&&s.status<=9?"view":void 0}),(l==="advisor"&&s.status==="7"||l==="chairpersons"&&s.status==="8"||l==="dean"&&s.status==="9")&&o.jsx(O,{size:"xs",color:"green",onClick:()=>{z(s),F("cancel"),g(!0)},children:"ลงความเห็น"})]})})]},s.request_cancel_exam_id));return o.jsxs(N,{children:[o.jsx(me,{opened:u.open,onClose:D,message:u.message,type:u.type}),o.jsx(fe,{opened:B,onClose:()=>g(!1),selectedRow:C,selected:E,setSelected:P,comment:A,setComment:t,error:I,openApproveState:L,handleCancel:pe,role:l,title:`ลงความเห็นคำร้องขอยกเลิกการเข้าสอบ${v.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`}),o.jsx(Re,{opened:M,onClose:()=>R(!1),selectedRow:C,reason:r,setReason:X,error:I,handleAddCancel:ce}),o.jsx(he,{size:"1.5rem",fw:900,mb:"md",children:`คำร้องขอยกเลิกการเข้าสอบ${v.education_level?`${v.education_level==="ปริญญาโท"?"ประมวลความรู้":"วัดคุณสมบัติ"}`:"ประมวลความรู้/สอบวัดคุณสมบัติ"}`}),o.jsxs(ee,{justify:"space-between",children:[o.jsx(N,{children:o.jsxs(se,{align:"flex-end",gap:"sm",children:[l!=="student"&&o.jsx(j,{placeholder:"ค้นหาชื่่อ รหัส",value:K,onChange:s=>oe(s.target.value)}),l!=="student"&&o.jsx(Y,{placeholder:"ชนิดคำขอ",data:["ขอยกเลิกการเข้าสอบประมวลความรู้","ขอยกเลิกการเข้าสอบวัดคุณสมบัติ"],value:J,onChange:re}),o.jsx(Y,{placeholder:"เทอมการศึกษา",data:ae,value:w,onChange:Q,allowDeselect:!1})]})}),o.jsx(N,{children:l==="student"&&o.jsx(o.Fragment,{children:o.jsx(O,{onClick:()=>le(),disabled:!((S?.status==="1"||S?.status==="2"||S?.status==="3"||S?.status==="4"||S?.status==="5")&&S?.exam_results===null),children:"ขอยกเลิก"})})})]}),o.jsx(Te,{h:"md"}),o.jsx(ye,{type:"scroll",offsetScrollbars:!0,style:{borderRadius:"8px",border:"1px solid #e0e0e0"},children:o.jsxs(x,{horizontalSpacing:"sm",verticalSpacing:"sm",highlightOnHover:!0,children:[o.jsx(x.Thead,{children:o.jsxs(x.Tr,{children:[o.jsx(x.Th,{style:{minWidth:100},children:"ชื่อ"}),o.jsx(x.Th,{children:"ภาคเรียน"}),o.jsx(x.Th,{style:{minWidth:100},children:"เรื่อง"}),o.jsx(x.Th,{style:{minWidth:110},children:"สถานะ"}),o.jsx(x.Th,{children:"การดำเนินการ"})]})}),o.jsx(x.Tbody,{children:de})]})})]})};export{Xe as default};
