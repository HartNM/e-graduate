name: Deploy E-Graduate System

on:
  push:
    branches: ["master"] # ทำงานเมื่อมีการ push เข้า branch master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted # รันบน Windows Server ของคุณ

    steps:
      # ดึงโค้ดล่าสุดมาที่เครื่อง Server (ในโฟลเดอร์ของ Runner)
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # ส่วนของ Frontend (App) -> ไปที่ Nginx
      # ---------------------------------------------------------
      - name: Install Frontend Dependencies
        working-directory: ./app
        run: npm install

      - name: Create .env for Production
        working-directory: ./app
        run: |
          # เขียนค่า IP ของ Server ลงไปในไฟล์ .env
          echo "VITE_API_URL=${{ secrets.SERVER_IP }}" > .env

      - name: Build Frontend
        working-directory: ./app
        run: npm run build

      - name: Deploy Frontend to Nginx
        run: |
          # ลบไฟล์เก่าใน Nginx html ออกก่อน (ยกเว้นบางไฟล์ถ้าจำเป็น)
          Remove-Item -Path "C:\Program Files\nginx\html\*" -Recurse -Force -ErrorAction SilentlyContinue

          # ก๊อปปี้ไฟล์จาก folder 'dist' ไปที่ Nginx
          Copy-Item -Path ".\app\dist\*" -Destination "C:\Program Files\nginx\html" -Recurse -Force

          Write-Host "Frontend Deployed Successfully!"

      # ---------------------------------------------------------
      # ส่วนของ Backend (Server) -> รันด้วย PM2
      # ---------------------------------------------------------
      #- name: Install Backend Dependencies
      #  working-directory: ./server
      #  run: npm install

      # สร้างไฟล์ .env (ถ้าใช้วิธี GitHub Secrets) หรือข้ามส่วนนี้ถ้าคุณวางไฟล์ .env ไว้เองแล้ว
      - name: Create Backend .env
        working-directory: ./server
        run: |
          # สร้างไฟล์ .env สำหรับ Backend โดยดึงค่าจาก Secrets
          echo "PORT=8080" > .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "USER=${{ secrets.DB_USER }}" >> .env
          echo "PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "SERVER=${{ secrets.DB_SERVER }}" >> .env
          echo "DATABASE=${{ secrets.DB_NAME }}" >> .env

          # เช็คว่าไฟล์ถูกสร้างจริง (แต่จะไม่โชว์รหัสผ่านออกมา)
          Write-Host "Backend .env created successfully."

      #- name: Restart Backend API
      #  working-directory: ./server
      #  run: |
      #    # Restart process ชื่อ egraduate-api และให้อ่านค่า env ใหม่
      #    pm2 restart egraduate-api --update-env
